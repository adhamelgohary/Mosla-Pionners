{# templates/recruiter_team_portal/team_leaderboard.html #}
{% extends "recruiter_team_portal/recruiter_base.html" %}

{% block recruiter_title %}{{ title }}{% endblock %}
{% block recruiter_page_title %}{{ title }}{% endblock %}

{% block head_extra %}
    {{ super() }}
    <!-- Add ApexCharts.js library -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{# *** CORRECTED: ONLY ONE 'recruiter_content' BLOCK *** #}
{% block recruiter_content %}
<div class="px-4 sm:px-0">
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <p class="mt-1 text-sm text-gray-600">A dynamic ranking of the top sourcing team performers.</p>
        </div>
        <div class="mt-4 sm:mt-0">
            <form method="GET" action="{{ url_for('.team_leaderboard') }}">
                <label for="sort_by" class="sr-only">Sort by</label>
                <select name="sort_by" id="sort_by" onchange="this.form.submit()" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="referrals_all_time" {% if current_sort == 'referrals_all_time' %}selected{% endif %}>Sort by All-Time Referrals</option>
                    <option value="hires_all_time" {% if current_sort == 'hires_all_time' %}selected{% endif %}>Sort by All-Time Hires</option>
                    <option value="referrals_monthly" {% if current_sort == 'referrals_monthly' %}selected{% endif %}>Sort by Referrals (This Month)</option>
                    <option value="hires_monthly" {% if current_sort == 'hires_monthly' %}selected{% endif %}>Sort by Hires (This Month)</option>
                </select>
            </form>
        </div>
    </div>

    <!-- Leaderboard Chart Container -->
    <div class="mt-8 bg-white p-6 rounded-lg shadow-sm border">
        <div id="leaderboard-chart"></div>
    </div>
</div>

{# The script is now placed inside the single content block #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const leaderboardData = {{ leaderboard_data|tojson }};
    const sortKey = "{{ current_sort }}";

    // Determine which data key to use for the series based on the current sort
    let seriesDataKey, seriesName;
    if (sortKey === 'hires_all_time') {
        seriesDataKey = 'hires_all_time';
        seriesName = 'Total Hires';
    } else if (sortKey === 'referrals_monthly') {
        seriesDataKey = 'referrals_monthly';
        seriesName = 'Monthly Referrals';
    } else if (sortKey === 'hires_monthly') {
        seriesDataKey = 'hires_monthly';
        seriesName = 'Monthly Hires';
    } else {
        seriesDataKey = 'referrals_all_time';
        seriesName = 'Total Referrals';
    }

    if (leaderboardData.length > 0) {
        const leaderboardOptions = {
            series: [{
                name: seriesName,
                data: leaderboardData.map(item => item[seriesDataKey])
            }],
            chart: {
                type: 'bar',
                height: 350 + (leaderboardData.length * 20), // Dynamic height
                toolbar: { show: false }
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    horizontal: true,
                    distributed: true, // This gives each bar a different color
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val, opt) {
                    return val
                },
                style: {
                    fontSize: '12px',
                    fontWeight: 'bold',
                    colors: ["#fff"]
                }
            },
            xaxis: {
                categories: leaderboardData.map(item => `${item.FirstName} ${item.LastName}`),
            },
            legend: {
                show: false // Hide legend since we use distributed colors
            },
            colors: [ // A palette of colors for the bars
                '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#EC4899',
                '#F43F5E', '#F97316', '#F59E0B', '#84CC16', '#10B981'
            ],
            tooltip: {
                y: {
                    formatter: function(value, { series, seriesIndex, dataPointIndex, w }) {
                        const data = leaderboardData[dataPointIndex];
                        return `
                            <div><b>${seriesName}: ${value}</b></div>
                            <div>Total Referrals: ${data.referrals_all_time}</div>
                            <div>Total Hires: ${data.hires_all_time}</div>
                        `;
                    },
                    title: {
                        formatter: (seriesName) => ''
                    }
                }
            }
        };
        const leaderboardChart = new ApexCharts(document.querySelector("#leaderboard-chart"), leaderboardOptions);
        leaderboardChart.render();
    } else {
        document.querySelector("#leaderboard-chart").innerHTML = '<div class="text-center text-gray-500 py-16">No leaderboard data available for this criteria.</div>';
    }
});
</script>
{% endblock %}