{% extends "recruiter_team_portal/recruiter_base.html" %}

{% block recruiter_title %}Organization Management{% endblock %}

{% block recruiter_page_title_icon %}
<i class="bi bi-diagram-3-fill text-2xl text-primary"></i>
{% endblock %}

{% block recruiter_page_title %}Organization Management: Units{% endblock %}

{% block recruiter_content %}
<div class="space-y-8">
    <!-- Create New Unit Section -->
    <div x-data="{ open: false }" class="bg-card shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-medium leading-6 text-heading">Create a New Unit</h3>
                <button @click="open = !open" class="btn btn-secondary">
                    <span x-show="!open">Create</span>
                    <span x-show="open">Cancel</span>
                </button>
            </div>
            <div x-show="open" x-collapse class="mt-4">
                <form action="{{ url_for('organization_bp.create_unit') }}" method="POST" class="space-y-4">
                    <div>
                        <label for="unit_name" class="form-label">Unit Name</label>
                        <input type="text" name="unit_name" id="unit_name" class="form-input" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn btn-primary">Save Unit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Units List Section -->
    <div class="bg-card shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg leading-6 font-medium text-heading">Sourcing Units</h3>
                <p class="mt-1 max-w-2xl text-sm text-text-secondary">Manage organizational units and assign managers.</p>
            </div>
            <a href="{{ url_for('organization_bp.list_units', show_all=not show_all) }}" class="btn btn-secondary">
                {{ 'Show Active Only' if show_all else 'Show All (incl. Inactive)' }}
            </a>
        </div>
        <div class="border-t border-gray-200 dark:border-slate-700">
            <ul role="list" class="divide-y divide-gray-200 dark:divide-slate-700">
                {% for unit in units %}
                <li class="p-4 sm:p-6 hover:bg-background-hover {{ 'opacity-60' if not unit.IsActive }}" x-data="{ modalOpen: false }">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-x-3">
                                <a href="{{ url_for('organization_bp.manage_unit', unit_id=unit.UnitID) }}" class="text-lg font-semibold text-primary hover:underline">{{ unit.UnitName }}</a>
                                {% if unit.IsActive %}
                                    <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Active</span>
                                {% else %}
                                    <span class="inline-flex items-center rounded-full bg-gray-200 px-2.5 py-0.5 text-xs font-medium text-gray-800">Inactive</span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-text-secondary mt-1">
                                Manager: 
                                {% if unit.FirstName %}
                                    {{ unit.FirstName }} {{ unit.LastName }}
                                {% else %}
                                    <span class="text-yellow-600">Not Assigned</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="flex items-center gap-x-2">
                           {% if unit.IsActive %}
                            <!-- Deactivate Button -->
                            <div x-data="{ modalOpen: false }">
                                <button @click="modalOpen = true" class="btn btn-secondary text-yellow-600 hover:bg-yellow-100">Deactivate</button>
                                {% with modal_id='deactivate-unit-'~unit.UnitID, action_url=url_for('organization_bp.deactivate_unit', unit_id=unit.UnitID), danger_level='warning', modal_title='Deactivate Unit?', modal_body='This will deactivate the unit and unassign all associated teams and staff. Are you sure?', button_text='Deactivate' %}
                                    {% include 'recruiter_team_portal/partials/_confirmation_modal.html' %}
                                {% endwith %}
                            </div>
                           {% else %}
                            <!-- Activate Button -->
                            <form action="{{ url_for('organization_bp.activate_unit', unit_id=unit.UnitID) }}" method="POST">
                                <button type="submit" class="btn btn-secondary text-green-600 hover:bg-green-100">Activate</button>
                            </form>
                            <!-- Delete Button -->
                            <div x-data="{ modalOpen: false }">
                                <button @click="modalOpen = true" class="btn btn-danger">Delete</button>
                                {% with modal_id='delete-unit-'~unit.UnitID, action_url=url_for('organization_bp.delete_unit', unit_id=unit.UnitID), danger_level='danger', modal_title='Permanently Delete Unit?', modal_body='This action is irreversible and will delete the unit and all teams within it. The unit must be inactive. Are you sure?', button_text='Delete Permanently' %}
                                    {% include 'recruiter_team_portal/partials/_confirmation_modal.html' %}
                                {% endwith %}
                            </div>
                           {% endif %}
                        </div>
                    </div>

                    <!-- Assign Manager Form -->
                    <form action="{{ url_for('organization_bp.assign_unit_manager') }}" method="POST" class="mt-4 pt-4 border-t border-gray-200 dark:border-slate-800 flex items-end gap-4">
                        <input type="hidden" name="unit_id" value="{{ unit.UnitID }}">
                        <div class="flex-grow">
                            <label for="manager_staff_id_{{ unit.UnitID }}" class="form-label">Assign Unit Manager</label>
                            <select name="manager_staff_id" id="manager_staff_id_{{ unit.UnitID }}" class="form-input">
                                <option value="">Select a Manager...</option>
                                {% for manager in potential_managers %}
                                    <option value="{{ manager.StaffID }}" {% if unit.UnitManagerStaffID == manager.StaffID %}selected{% endif %}>
                                        {{ manager.FullName }} ({{ manager.Role }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </form>
                </li>
                {% else %}
                <li class="p-6 text-center text-text-secondary">No units found.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}