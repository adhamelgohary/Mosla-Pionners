{% extends "recruiter_team_portal/recruiter_base.html" %}

{% block recruiter_title %}{{ title }}{% endblock %}

{% block recruiter_page_title_icon %}
<i class="bi bi-collection-fill text-2xl text-primary"></i>
{% endblock %}

{% block recruiter_page_title %}
{{ title }}
{% endblock %}

{% block recruiter_content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6" x-data="{ createTeamModal: false, deactivateTeamModal: false, deleteTeamModal: false, selectedTeam: {} }">
    <!-- Left Column: Teams List -->
    <div class="lg:col-span-2">
        <div class="bg-card shadow-md rounded-lg overflow-hidden">
             <div class="p-4 border-b border-border flex justify-between items-center">
                <h3 class="text-lg font-semibold text-heading">Teams in this Unit</h3>
                <a href="{{ url_for('organization_bp.manage_unit', unit_id=unit.UnitID, show_all=not show_all) }}" class="btn btn-secondary-outline btn-sm">
                    <i class="bi bi-eye{{ '-slash' if show_all else '' }}"></i>
                    {{ 'Show Active' if show_all else 'Show All' }}
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-border">
                    <thead class="bg-background-alt">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Team Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Lead</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-text-muted uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-card divide-y divide-border">
                        {% for team in teams_in_unit %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><a href="{{ url_for('organization_bp.manage_team', team_id=team.TeamID) }}" class="font-medium text-primary hover:text-primary-darker">{{ team.TeamName }}</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-text">{{ team.LeadFirstName + ' ' + team.LeadLastName if team.LeadFirstName else 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if team.IsActive %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-alert-success-bg text-alert-success-text">Active</span>
                                {% else %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-alert-danger-bg text-alert-danger-text">Inactive</span>{% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                 {% if team.IsActive %}
                                    <a href="{{ url_for('organization_bp.manage_team', team_id=team.TeamID) }}" class="btn btn-secondary-outline btn-sm" title="Manage Team"><i class="bi bi-pencil"></i></a>
                                    <button @click="selectedTeam = {{ team | tojson }}; deactivateTeamModal = true" class="btn btn-warning-outline btn-sm" title="Deactivate Team"><i class="bi bi-archive"></i></button>
                                 {% else %}
                                    <form action="{{ url_for('organization_bp.activate_team', team_id=team.TeamID) }}" method="POST" class="inline-block">
                                        <button type="submit" class="btn btn-success-outline btn-sm" title="Activate Team"><i class="bi bi-check-circle"></i></button>
                                    </form>
                                    {% if current_user.role_type in ['HeadUnitManager', 'CEO', 'Founder'] %}
                                    <button @click="selectedTeam = {{ team | tojson }}; deleteTeamModal = true" class="btn btn-danger-outline btn-sm" title="Delete Team Permanently"><i class="bi bi-trash"></i></button>
                                    {% endif %}
                                 {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center py-10 text-text-muted">No teams found in this unit.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right Column: Management Actions -->
    <div class="space-y-6">
        {# CORRECTED THIS SECTION #}
        {% if current_user.role_type in ['UnitManager', 'HeadUnitManager', 'CEO', 'Founder'] %}
        <div class="bg-card shadow-md rounded-lg p-6">
            <h3 class="text-lg font-semibold text-heading mb-4">Unit Actions</h3>
            <button @click="createTeamModal = true" class="btn btn-primary w-full">
                <i class="bi bi-plus-circle"></i> Create New Team
            </button>
        </div>
        {% endif %}
        
        <div class="bg-card shadow-md rounded-lg p-6">
            <h3 class="text-lg font-semibold text-heading mb-4">Assign Recruiter to a Team</h3>
            <form action="{{ url_for('organization_bp.assign_recruiter_to_team') }}" method="POST" class="space-y-4">
                <div>
                    <label for="team_id_recruiter" class="block text-sm font-medium text-text-muted">1. Choose Team</label>
                    <select id="team_id_recruiter" name="team_id" class="input mt-1 w-full" required>
                        <option value="">-- Select a team --</option>
                        {% for team in teams_in_unit %}{% if team.IsActive %}<option value="{{ team.TeamID }}">{{ team.TeamName }}</option>{% endif %}{% endfor %}
                    </select>
                </div>
                <div>
                    <label for="recruiter_staff_id_unit" class="block text-sm font-medium text-text-muted">2. Choose Recruiter</label>
                    <select id="recruiter_staff_id_unit" name="recruiter_staff_id" class="input mt-1 w-full" {% if not unassigned_recruiters %}disabled{% endif %} required>
                        <option value="">-- Select unassigned recruiter --</option>
                        {% for recruiter in unassigned_recruiters %}<option value="{{ recruiter.StaffID }}">{{ recruiter.FirstName }} {{ recruiter.LastName }}</option>{% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full" {% if not unassigned_recruiters %}disabled{% endif %}>Assign Recruiter</button>
                {% if not unassigned_recruiters %}<p class="text-xs text-center text-text-muted mt-2">No unassigned recruiters available.</p>{% endif %}
            </form>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Create Team Modal -->
    <div x-show="createTeamModal" class="fixed z-50 inset-0 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen">
            <div x-show="createTeamModal" x-transition.opacity @click="createTeamModal = false" class="fixed inset-0 bg-gray-500 opacity-75"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">â€‹</span>
            <div x-show="createTeamModal" x-transition class="inline-block align-bottom bg-card rounded-lg text-left overflow-hidden shadow-xl transform sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form action="{{ url_for('organization_bp.create_team') }}" method="POST">
                    <input type="hidden" name="unit_id" value="{{ unit.UnitID }}">
                    <div class="bg-card px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 class="text-lg leading-6 font-medium text-heading">Create New Team in {{ unit.UnitName }}</h3><div class="mt-4"><label for="team_name" class="block text-sm font-medium text-text-muted">Team Name</label><input type="text" name="team_name" id="team_name" class="input mt-1 block w-full" required></div></div>
                    <div class="bg-background-alt px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="submit" class="btn btn-primary w-full sm:ml-3 sm:w-auto">Create Team</button><button type="button" @click="createTeamModal = false" class="btn btn-secondary mt-3 w-full sm:mt-0 sm:w-auto">Cancel</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deactivate Team Modal -->
    <div x-show="deactivateTeamModal" class="fixed z-50 inset-0 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen">
            <div x-show="deactivateTeamModal" x-transition.opacity @click="deactivateTeamModal = false" class="fixed inset-0 bg-gray-500 opacity-75"></div>
            <div x-show="deactivateTeamModal" x-transition class="bg-card rounded-lg text-left overflow-hidden shadow-xl transform sm:max-w-lg sm:w-full">
                <form :action="'/recruiter-portal/organization/team/' + selectedTeam.TeamID + '/deactivate'" method="POST">
                     <div class="bg-card px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10"><i class="bi bi-exclamation-triangle-fill text-yellow-600"></i></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg font-medium leading-6 text-heading">Deactivate Team</h3><p class="text-sm text-text-muted mt-2">Are you sure? This will unassign all recruiters from <strong x-text="selectedTeam.TeamName"></strong>.</p></div></div></div>
                     <div class="bg-background-alt px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="btn btn-warning w-full sm:ml-3 sm:w-auto">Deactivate</button>
                        <button type="button" @click="deactivateTeamModal = false" class="btn btn-secondary mt-3 w-full sm:mt-0 sm:w-auto">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Team Modal -->
    <div x-show="deleteTeamModal" class="fixed z-50 inset-0 overflow-y-auto" style="display: none;">
         <div class="flex items-center justify-center min-h-screen">
            <div x-show="deleteTeamModal" x-transition.opacity @click="deleteTeamModal = false" class="fixed inset-0 bg-gray-500 opacity-75"></div>
            <div x-show="deleteTeamModal" x-transition class="bg-card rounded-lg text-left overflow-hidden shadow-xl transform sm:max-w-lg sm:w-full">
                <form :action="'/recruiter-portal/organization/team/' + selectedTeam.TeamID + '/delete'" method="POST">
                     <div class="bg-card px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><i class="bi bi-exclamation-triangle-fill text-red-600"></i></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg font-medium leading-6 text-heading">Permanently Delete Team</h3><p class="text-sm text-text-muted mt-2">Are you sure? This action for <strong x-text="selectedTeam.TeamName"></strong> is <strong class='text-red-500'>permanent and cannot be undone</strong>.</p></div></div></div>
                     <div class="bg-background-alt px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="btn btn-danger w-full sm:ml-3 sm:w-auto">Yes, Delete Permanently</button>
                        <button type="button" @click="deleteTeamModal = false" class="btn btn-secondary mt-3 w-full sm:mt-0 sm:w-auto">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}