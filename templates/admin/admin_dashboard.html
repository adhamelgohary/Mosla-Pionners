{% extends "base.html" %}

{% block content %}
<div class="space-y-10" 
     x-data="systemHealthMonitor()" 
     x-init="init()">

    <!-- Header -->
    <header>
        <h1 class="text-3xl font-bold tracking-tight text-heading">Dashboard</h1>
        <p class="mt-1 text-md text-text-muted">A quick overview of your application's status.</p>
    </header>

    <!-- Section: Key Statistics (This section remains unchanged) -->
    <div>
        <h2 class="text-lg font-medium text-heading">Key Statistics</h2>
        <div class="mt-2 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Stats cards... -->
            <div class="rounded-lg bg-blue-600 p-5 text-white shadow-lg">
                <i class="fas fa-user-plus fa-2x opacity-50"></i>
                <div class="mt-3 text-3xl font-bold">{{ data.app_stats.pending_client_registrations }}</div>
                <p class="text-sm font-medium uppercase tracking-wider opacity-75">Pending Clients</p>
            </div>
            <div class="rounded-lg bg-amber-500 p-5 text-white shadow-lg">
                <i class="fas fa-user-tie fa-2x opacity-50"></i>
                <div class="mt-3 text-3xl font-bold">{{ data.app_stats.pending_staff_applications }}</div>
                <p class="text-sm font-medium uppercase tracking-wider opacity-75">Staff Apps</p>
            </div>
            <div class="rounded-lg bg-green-600 p-5 text-white shadow-lg">
                <i class="fas fa-briefcase fa-2x opacity-50"></i>
                <div class="mt-3 text-3xl font-bold">{{ data.app_stats.active_jobs }}</div>
                <p class="text-sm font-medium uppercase tracking-wider opacity-75">Active Jobs</p>
            </div>
            <div class="rounded-lg bg-slate-700 p-5 text-white shadow-lg">
                <i class="fas fa-sign-in-alt fa-2x opacity-50"></i>
                <div class="mt-3 text-3xl font-bold">{{ data.app_stats.logins_24h }}</div>
                <p class="text-sm font-medium uppercase tracking-wider opacity-75">Logins (24h)</p>
            </div>
        </div>
    </div>

    <!-- Section: System Health (This section is now REAL-TIME) -->
    <div>
        <h2 class="text-lg font-medium text-heading">System Health</h2>
        <div class="mt-2 grid grid-cols-1 gap-8 lg:grid-cols-2">
            <!-- Global Server Performance Card -->
            <div class="card">
                <div class="card-header"><h3 class="font-semibold text-heading"><i class="fas fa-server mr-2 text-text-muted"></i>Server Resources</h3></div>
                <div class="card-body space-y-4">
                    <div>
                        <div class="flex justify-between text-sm font-medium text-text-muted"><span>Total CPU Usage</span><span x-text="stats.global.cpu_percent + '%'">...</span></div>
                        <div class="w-full bg-background rounded-full h-2 mt-1"><div class="bg-primary h-2 rounded-full" :style="`width: ${stats.global.cpu_percent}%`"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm font-medium text-text-muted"><span>Total Memory Usage</span><span x-text="stats.global.memory_percent + '%'">...</span></div>
                        <div class="w-full bg-background rounded-full h-2 mt-1"><div class="bg-success-500 h-2 rounded-full" :style="`width: ${stats.global.memory_percent}%`"></div></div>
                    </div>
                </div>
            </div>
            <!-- Service Status Card -->
            <div class="card">
                <div class="card-header"><h3 class="font-semibold text-heading"><i class="fas fa-cogs mr-2 text-text-muted"></i>Service Status</h3></div>
                <div class="card-body">
                    <ul class="divide-y divide-border">
                        <template x-for="service in Object.keys(stats.services)" :key="service">
                             <li class="flex items-center justify-between py-3">
                                <div class="flex items-center">
                                    <span class="h-2 w-2 rounded-full mr-3" :class="stats.services[service].status === 'Running' ? 'bg-green-500' : 'bg-red-500'"></span>
                                    <p class="font-medium text-heading" x-text="service"></p>
                                </div>
                                <div class="text-sm text-text-muted">
                                    <span x-text="stats.services[service].status">...</span>
                                    <template x-if="stats.services[service].status === 'Running'">
                                        <span>(<span x-text="stats.services[service].cpu + '% CPU'"></span>, <span x-text="stats.services[service].memory + ' MB'"></span>)</span>
                                    </template>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function systemHealthMonitor() {
    return {
        // Default state before first fetch
        stats: {
            global: { cpu_percent: 0, memory_percent: 0 },
            services: { 
                'Nginx': { status: 'Loading...', cpu: 0, memory: 0 },
                'MySQL': { status: 'Loading...', cpu: 0, memory: 0 },
            }
        },
        // Fetch data immediately on load, then set an interval to repeat
        init() {
            this.fetchStats();
            setInterval(() => {
                this.fetchStats();
            }, 3000); // Refresh every 3 seconds
        },
        // The function that gets the data
        async fetchStats() {
            try {
                const response = await fetch('/admin/system-stats');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                this.stats = data;
            } catch (error) {
                console.error("Failed to fetch system stats:", error);
                // You could update the UI to show an error state here
            }
        }
    }
}
</script>
{% endblock %}