{% extends "base.html" %}

{% block content %}
<div class="space-y-10" 
     x-data="dashboardMonitor()" 
     x-init="init()">

    <!-- Header -->
    <header>
        <h1 class="text-3xl font-bold tracking-tight text-heading">Dashboard</h1>
        <p class="mt-1 text-md text-text-muted">Live overview of your application and server status.</p>
    </header>

    <!-- Section: Key Application Metrics -->
    <!-- This section remains the same -->
    
    <!-- Section: System Health & Activity -->
    <div>
        <h2 class="text-lg font-medium text-heading">System Health & Activity</h2>
        <!-- UPDATED: Changed grid to lg:grid-cols-4 to make space for the new card -->
        <div class="mt-2 grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-4">
            
            <!-- Column 1: Server Resources Card -->
            <div class="card lg:col-span-1">
                <div class="card-header"><h3 class="font-semibold text-heading"><i class="fas fa-server mr-2 text-text-muted"></i>Server Resources</h3></div>
                <div class="card-body divide-y divide-border">
                    <div class="py-3">
                        <div class="flex justify-between text-sm font-medium text-text-muted"><span>CPU Usage</span><span x-text="systemStats.global.cpu_percent + '%'">...</span></div>
                        <div class="w-full bg-background rounded-full h-2 mt-1"><div class="bg-primary h-2 rounded-full" :style="`width: ${systemStats.global.cpu_percent}%`"></div></div>
                    </div>
                    <div class="py-3">
                        <div class="flex justify-between text-sm font-medium text-text-muted"><span>Memory Usage</span><span x-text="systemStats.global.memory_percent + '%'">...</span></div>
                        <div class="w-full bg-background rounded-full h-2 mt-1"><div class="bg-success-500 h-2 rounded-full" :style="`width: ${systemStats.global.memory_percent}%`"></div></div>
                    </div>
                     <div class="py-3 text-sm text-text-muted">
                        <strong>Uptime:</strong> <span x-text="systemStats.global.uptime_str">...</span>
                    </div>
                </div>
            </div>

            <!-- Column 2: Service Status Card -->
            <div class="card lg:col-span-1">
                <div class="card-header"><h3 class="font-semibold text-heading"><i class="fas fa-cogs mr-2 text-text-muted"></i>Service Status</h3></div>
                <div class="card-body">
                    <ul class="divide-y divide-border">
                        <template x-for="service in Object.keys(systemStats.services)" :key="service">
                            <li class="flex items-center justify-between py-3">
                                <div class="flex items-center"><span class="h-2 w-2 rounded-full mr-3" :class="systemStats.services[service].status === 'Running' ? 'bg-green-500' : 'bg-red-500'"></span><p class="font-medium text-heading" x-text="service"></p></div>
                                <div class="text-sm text-text-muted" x-text="systemStats.services[service].status">...</div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>

            <!-- Column 3: NEW Bandwidth Usage Card -->
            <div class="card lg:col-span-1">
                <div class="card-header"><h3 class="font-semibold text-heading"><i class="fas fa-exchange-alt mr-2 text-text-muted"></i>Bandwidth Usage</h3></div>
                <div class="card-body">
                    <template x-if="!systemStats.bandwidth.error">
                        <div class="text-center">
                            <p class="text-sm text-text-muted" x-text="systemStats.bandwidth.month + ' Usage'"></p>
                            <p class="text-4xl font-bold text-heading mt-2" x-text="systemStats.bandwidth.total_gb + ' GB'"></p>
                        </div>
                    </template>
                    <template x-if="systemStats.bandwidth.error">
                        <div class="text-center text-sm text-amber-600 bg-amber-50 p-3 rounded-md">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <span x-text="systemStats.bandwidth.error"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Column 4: Real-time Security Log -->
            <div class="card lg:col-span-1">
                <div class="card-header"><h3 class="font-semibold text-heading"><i class="fas fa-shield-alt mr-2 text-danger"></i>Recent Failed Logins</h3></div>
                <div class="card-body">
                    <ul class="space-y-3 h-28 overflow-y-auto">
                        <template x-if="!appStats.recent_failed_logins || appStats.recent_failed_logins.length === 0">
                            <li class="text-center text-sm text-text-muted pt-4">
                                <i class="fas fa-check-circle text-green-500"></i> No failed logins recently.
                            </li>
                        </template>
                        <template x-for="log in appStats.recent_failed_logins" :key="log.AttemptedAt">
                            <li class="flex items-center text-sm">
                                <i class="fas fa-user-secret mr-3 text-danger-300"></i>
                                <div>
                                    <p class="font-semibold text-heading truncate" x-text="log.EmailAttempt"></p>
                                    <p class="text-text-muted"><span x-text="log.IPAddress"></span> at <span x-text="log.AttemptedAt"></span></p>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alpine.js script remains the same -->
<script>
function dashboardMonitor() {
    return {
        // Add bandwidth to the default state
        systemStats: {
            global: { cpu_percent: 0, memory_percent: 0, load_avg: [0,0,0], uptime_str: '...' },
            services: { 'Nginx': { status: 'Loading...' }, 'MySQL': { status: 'Loading...' } },
            bandwidth: { month: '...', total_gb: '...', error: null }
        },
        appStats: {
            new_users_24h: '...',
            recent_failed_logins: []
        },
        // init() and fetch functions remain the same
        init() {
            this.fetchSystemStats();
            this.fetchAppStats();
            
            setInterval(() => {
                this.fetchSystemStats();
                this.fetchAppStats();
            }, 5000); // Refresh every 5 seconds
        },
        async fetchSystemStats() {
            try {
                const response = await fetch('/admin/system-stats');
                if (response.ok) this.systemStats = await response.json();
            } catch (error) { console.error("Failed to fetch system stats:", error); }
        },
        async fetchAppStats() {
            try {
                const response = await fetch('/admin/app-activity-stats');
                if (response.ok) this.appStats = await response.json();
            } catch (error) { console.error("Failed to fetch app stats:", error); }
        }
    }
}
</script>
{% endblock %}