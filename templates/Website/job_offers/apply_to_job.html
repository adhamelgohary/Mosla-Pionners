{% extends "Website/base.html" %}

{% block title %}Apply for {{ offer.Title }} - Mosla Pioneers{% endblock %}

{% block head_extra %}
    {{ super() }}
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <!-- This specific stylesheet will control the entire page's look -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/job_offer_detail_styles.css') }}">
{% endblock %}

{% block content %}
<div class="job-offer-detail-hsbc-style">
    <main class="hsbc-main-content">
        <div class="page-container">
            {% if offer and current_user.is_authenticated and current_user.role_type == 'Candidate' %}
            <!-- Form Panel -->
            <div class="form-panel application-form">
                <h3>Apply for: {{ offer.Title }}</h3>
                <form id="applicationForm" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="full_name" value="{{ form_data.get('full_name', '') }}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="text" id="email" name="email" value="{{ form_data.get('email', '') }}" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number *</label>
                        <input type="text" id="phoneNumber" name="phone_number" value="{{ form_data.get('phone_number', '') }}" required>
                    </div>
                    <div class="form-group">
                        <label for="referralCode">Referral Code (Optional)</label>
                        <input type="text" id="referralCode" name="referral_code" value="{{ form_data.get('referral_code', '') }}" placeholder="e.g., JOHN123">
                        <div id="referralCodeFeedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="candidateQuestions">Why are you interested in this role? *</label>
                        <textarea id="candidateQuestions" name="candidateQuestions" required>{{ form_data.get('candidateQuestions', '') }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="cv_file">Upload Your CV *</label>
                        <input type="file" id="cv_file" name="cv_file" accept=".pdf,.doc,.docx" required>
                    </div>
                    <div class="form-group">
                        <label for="voice_note_file">Upload Your Voice Introduction *</label>
                        <p style="font-size:13px; margin-top:0;">Please record and upload a 60-90 second audio file (.mp3, .m4a, .wav).</p>
                        <input type="file" id="voice_note_file" name="voice_note_file" accept=".mp3,.m4a,.wav,.webm,.ogg" required>
                    </div>
                    
                    <!-- FIX: Using id="sendBtn" to match the style in your CSS file -->
                    <button type="submit" id="sendBtn">Send Application</button>
                    
                    <div id="formErrorMessages" class="alert" style="display:none; margin-top: 20px;"></div>
                </form>
            </div>
            {% else %}
            <div class="form-panel">
                <h3>Application Error</h3>
                <p>You must be logged in as a Candidate to apply for this job.</p>
                <a href="{{ url_for('login_bp.login') }}" class="action-button">Login</a>
            </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block page_scripts %}
    {{ super() }}
    <script>
    // This script remains largely the same but will now interact with the newly classed elements.
    document.addEventListener('DOMContentLoaded', () => {
        const applicationForm = document.getElementById('applicationForm');
        if (!applicationForm) return;

        const sendBtn = document.getElementById('sendBtn');
        const formErrorMessagesDiv = document.getElementById('formErrorMessages');

        applicationForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            formErrorMessagesDiv.style.display = 'none';
            formErrorMessagesDiv.textContent = '';
            
            const formData = new FormData(applicationForm);
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'Submitting...';

            try {
                const response = await fetch("{{ url_for('job_board_bp.submit_application_form', offer_id=offer.OfferID) }}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content') }
                });
                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    alert(result.message || "Application submitted successfully!");
                    window.location.href = result.redirect_url || "{{ url_for('job_board_bp.job_offers_list') }}";
                } else {
                    let errorMessage = result.message || 'Please correct the errors.';
                    if (result.errors) {
                        const errorList = Object.values(result.errors).join('\n');
                        errorMessage += '\n' + errorList;
                    }
                    formErrorMessagesDiv.textContent = errorMessage;
                    formErrorMessagesDiv.className = 'alert alert-danger';
                    formErrorMessagesDiv.style.display = 'block';
                }
            } catch (error) {
                formErrorMessagesDiv.textContent = "An unexpected network error occurred. Please try again.";
                formErrorMessagesDiv.className = 'alert alert-danger';
                formErrorMessagesDiv.style.display = 'block';
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Application';
            }
        });
    });
    </script>
{% endblock %}

{% block footer %}{% endblock footer %}