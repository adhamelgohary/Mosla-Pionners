{% extends "Website/base.html" %}

{% block title %}Apply for {{ offer.Title }} - Mosla Pioneers{% endblock %}

{% block head_extra %}
    {{ super() }}
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <style>
      .invalid-feedback { display: none; }
      .is-invalid + .invalid-feedback, 
      .is-invalid ~ .invalid-feedback { display: block; }
    </style>
{% endblock %}

{% block content %}
<div class="job-detail-page-wrapper">
    <main class="relative z-10 bg-transparent py-8 sm:py-12">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            {% if offer and current_user.is_authenticated and current_user.role_type == 'Candidate' %}
                <form id="applicationForm" method="POST" enctype="multipart/form-data" class="bg-card/90 backdrop-blur-sm p-6 sm:p-8 lg:p-10 rounded-2xl shadow-xl space-y-8 border border-border/50">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-heading">Apply for {{ offer.Title }}</h2>
                        <p class="mt-2 text-sm text-text-muted">Please complete the form below. Fields marked with <span class="text-danger-500">*</span> are required. <a href="{{ url_for('job_board_bp.job_detail', offer_id=offer.OfferID) }}" class="font-medium text-primary hover:text-primary-darker">View job details again</a>.</p>
                    </div>

                    <div id="formErrorMessages" class="hidden rounded-md bg-danger-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0"><svg class="h-5 w-5 text-danger-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg></div>
                            <div class="ml-3"><div id="formErrorContent" class="text-sm text-danger-700"></div></div>
                        </div>
                    </div>

                    <div class="border-t border-border pt-8 space-y-6">
                        <div>
                            <label for="fullName" class="block text-sm font-medium leading-6 text-text">Full Name <span class="text-danger-500">*</span></label>
                            <div class="mt-2"><input type="text" id="fullName" name="full_name" value="{{ form_data.get('full_name', '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_full_name"></p>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium leading-6 text-text">Email <span class="text-danger-500">*</span></label>
                            <div class="mt-2"><input type="email" id="email" name="email" value="{{ form_data.get('email', '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_email"></p>
                        </div>
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium leading-6 text-text">Phone Number <span class="text-danger-500">*</span></label>
                            <div class="mt-2"><input type="tel" id="phoneNumber" name="phone_number" value="{{ form_data.get('phone_number', '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_phone_number"></p>
                        </div>
                        <div>
                            <label for="referralCode" class="block text-sm font-medium leading-6 text-text">Referral Code (Optional)</label>
                            <div class="mt-2"><input type="text" id="referralCode" name="referral_code" value="{{ form_data.get('referral_code', '') }}" placeholder="e.g., JOHN123" class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                            <div id="referralCodeFeedback" class="text-sm mt-2"></div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_referral_code"></p>
                        </div>
                        <div>
                            <label for="candidateQuestions" class="block text-sm font-medium leading-6 text-text">Why are you interested in this role? <span class="text-danger-500">*</span></label>
                            <div class="mt-2"><textarea id="candidateQuestions" name="candidateQuestions" required rows="4" class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input">{{ form_data.get('candidateQuestions', '') }}</textarea></div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_candidateQuestions"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium leading-6 text-text">Record a Voice Introduction <span class="text-danger-500">*</span></label>
                            <p class="mt-1 text-sm text-text-muted">In 60-90 seconds, introduce yourself and briefly answer: 1. Why a call center role? 2. What makes you a great fit?</p>
                            <div id="voice-recorder-wrapper" class="mt-4 p-4 rounded-lg ring-1 ring-inset ring-input-border">
                                <div class="flex flex-wrap items-center gap-4">
                                    <button type="button" id="startBtn" class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-darker focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-75">Start Record</button>
                                    <button type="button" id="stopBtn" disabled class="rounded-md bg-danger-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-danger-500 disabled:opacity-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-danger-600">Stop Record</button>
                                </div>
                                <audio id="audioPlayback" controls class="hidden mt-4 w-full"></audio>
                                <input type="hidden" name="voice_note_filename" id="voiceNoteFilename">
                            </div>
                             <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_voice_note"></p>
                        </div>
                        <div>
                            <label for="cvUpload" class="block text-sm font-medium leading-6 text-text">Upload Your CV <span class="text-danger-500">*</span></label>
                            <div class="mt-2"><input type="file" id="cvUpload" name="cv_file" accept=".pdf,.doc,.docx" required class="block w-full text-sm text-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer"></div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_cv_file"></p>
                        </div>
                    </div>

                    <div class="border-t border-border pt-8">
                        <button type="submit" id="sendBtn" class="w-full rounded-lg bg-primary px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-primary-darker focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-75">Send Application</button>
                    </div>
                </form>
            {% else %}
                 <div class="bg-card/90 backdrop-blur-sm p-10 rounded-2xl shadow-xl text-center border border-border/50">
                    <h3 class="text-xl font-bold text-heading">Application Error</h3>
                    <div class="mt-4 rounded-md bg-danger-50 p-4">
                        <p class="text-sm text-danger-700">There was a problem loading the application form. You must be logged in as a Candidate to apply.</p>
                    </div>
                    <a href="{{ url_for('job_board_bp.job_detail', offer_id=offer.OfferID) if offer else url_for('job_board_bp.job_offers_list') }}" class="mt-6 inline-block rounded-md bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-darker">Return to Job Details</a>
                </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block page_scripts %}
    {{ super() }}
    {# The JavaScript logic remains the same. It will now interact with the Tailwind-styled elements. #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const applicationForm = document.getElementById('applicationForm');
        if (!applicationForm) return;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const audioPlayback = document.getElementById('audioPlayback');
        const voiceNoteFilenameInput = document.getElementById('voiceNoteFilename');
        const referralCodeInput = document.getElementById('referralCode');
        const referralCodeFeedbackDiv = document.getElementById('referralCodeFeedback');
        const formErrorMessagesDiv = document.getElementById('formErrorMessages');
        const formErrorContent = document.getElementById('formErrorContent');
        const voiceRecorderWrapper = document.getElementById('voice-recorder-wrapper');

        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob = null;
        let debounceTimer;
        
        const markFieldValid = (field) => {
            field.classList.remove('ring-danger-500', 'is-invalid');
            field.classList.add('ring-input-border');
            const errorEl = field.closest('div').querySelector('.invalid-feedback');
            if(errorEl) errorEl.textContent = '';
        };
        const markFieldInvalid = (field, message) => {
            field.classList.add('ring-danger-500', 'is-invalid');
            field.classList.remove('ring-input-border');
            let errorEl = field.closest('div').querySelector('.invalid-feedback');
            if (field.id === 'voice-recorder-wrapper') {
                 errorEl = document.getElementById('error_voice_note');
            }
            if (errorEl) errorEl.textContent = message;
        };

        if (referralCodeInput) {
             referralCodeInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const code = referralCodeInput.value.trim().toUpperCase();
                referralCodeFeedbackDiv.textContent = ''; 
                referralCodeFeedbackDiv.className = 'text-sm mt-2';
                markFieldValid(referralCodeInput);
                
                if (code.length === 0) return;

                debounceTimer = setTimeout(() => {
                    referralCodeFeedbackDiv.textContent = 'Verifying...';
                    referralCodeFeedbackDiv.classList.add('text-text-muted');
                    fetch("{{ url_for('job_board_bp.validate_referral_code_api') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' },
                        body: JSON.stringify({ referral_code: code })
                    }).then(res => res.json()).then(data => {
                        referralCodeFeedbackDiv.className = 'text-sm mt-2';
                        if (data.status === 'success') {
                            referralCodeFeedbackDiv.textContent = `Referred by: ${data.recruiter_name}`;
                            referralCodeFeedbackDiv.classList.add('text-success-600');
                        } else {
                            referralCodeFeedbackDiv.textContent = data.message || 'Invalid code.';
                            referralCodeFeedbackDiv.classList.add('text-danger-600');
                        }
                    }).catch(err => {
                        referralCodeFeedbackDiv.textContent = 'Could not verify. Check connection.';
                        referralCodeFeedbackDiv.classList.add('text-warning-600');
                    });
                }, 750);
            });
        }
        
        if (startBtn) {
            startBtn.addEventListener('click', async () => {
                audioChunks = []; recordedAudioBlob = null;
                audioPlayback.classList.add('hidden'); audioPlayback.src = '';
                voiceNoteFilenameInput.value = '';
                voiceRecorderWrapper.classList.remove('ring-danger-500', 'is-invalid');
                voiceRecorderWrapper.classList.add('ring-input-border');
                const errorEl = document.getElementById('error_voice_note');
                if (errorEl) errorEl.textContent = '';
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        recordedAudioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType }); 
                        audioPlayback.src = URL.createObjectURL(recordedAudioBlob);
                        audioPlayback.classList.remove('hidden');
                        const autoVoiceFilename = `voice_intro_offer_{{ offer.OfferID }}_user_{{ current_user.id }}_${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
                        voiceNoteFilenameInput.value = autoVoiceFilename;
                    };
                    mediaRecorder.start();
                    startBtn.disabled = true; stopBtn.disabled = false; startBtn.innerHTML = 'Recording...';
                } catch (err) {
                    markFieldInvalid(voiceRecorderWrapper, 'Microphone error. Please grant permission and try again.');
                }
            });
        }
        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                if (mediaRecorder?.state !== "inactive") {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    startBtn.disabled = false; stopBtn.disabled = true; startBtn.innerHTML = 'Start Record';
                }
            });
        }
        
        applicationForm.action = "{{ url_for('job_board_bp.submit_application_form', offer_id=offer.OfferID) }}";

        applicationForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            formErrorMessagesDiv.classList.add('hidden');
            formErrorContent.innerHTML = '';
            document.querySelectorAll('.is-invalid').forEach(el => markFieldValid(el));
            
            const formData = new FormData(applicationForm);
            let hasClientSideErrors = false;
            
            if (!formData.get('full_name')?.trim()) { hasClientSideErrors=true; markFieldInvalid(document.getElementById('fullName'),'Full name is required.');}
            if (!formData.get('email')?.trim()) { hasClientSideErrors=true; markFieldInvalid(document.getElementById('email'), 'Email is required.');}
            if (!formData.get('phone_number')?.trim()) { hasClientSideErrors=true; markFieldInvalid(document.getElementById('phoneNumber'), 'Phone number is required.');}
            if (!formData.get('candidateQuestions')?.trim()) { hasClientSideErrors=true; markFieldInvalid(document.getElementById('candidateQuestions'), 'This field is required.');}
            if (!document.getElementById('cvUpload')?.files?.length > 0) { hasClientSideErrors=true; markFieldInvalid(document.getElementById('cvUpload'), 'CV upload is required.');}
            if (!recordedAudioBlob) { hasClientSideErrors=true; markFieldInvalid(voiceRecorderWrapper, 'Voice introduction is required.');}

            if (hasClientSideErrors) {
                formErrorContent.innerHTML = 'Please correct the errors highlighted below.';
                formErrorMessagesDiv.classList.remove('hidden');
                return;
            }

            formData.append('voice_note', recordedAudioBlob, voiceNoteFilenameInput.value);
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true; sendBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(applicationForm.action, { 
                    method: 'POST', 
                    body: formData, 
                    headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content') }
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    alert(result.message || "Application submitted successfully!");
                    window.location.href = result.redirect_url || "{{ url_for('job_board_bp.job_offers_list') }}";
                } else {
                    let errorHtml = `Please correct the following errors:<ul>${Object.values(result.errors || {}).map(e => `<li>${e}</li>`).join('')}</ul>`;
                    formErrorContent.innerHTML = errorHtml;
                    formErrorMessagesDiv.classList.remove('hidden');
                    Object.keys(result.errors || {}).forEach(field => {
                        const el = document.getElementById(field) || (field === 'voice_note' ? voiceRecorderWrapper : null);
                        if (el) markFieldInvalid(el, result.errors[field]);
                    });
                }
            } catch (error) {
                formErrorContent.innerHTML = "An unexpected network error occurred. Please check your connection and try again.";
                formErrorMessagesDiv.classList.remove('hidden');
            } finally {
                 sendBtn.disabled = false; sendBtn.textContent = 'Send Application';
            }
        });
    });
    </script>
{% endblock %}

{% block footer %}{% endblock footer %}