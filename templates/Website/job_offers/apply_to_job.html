{% extends "Website/base.html" %}

{% block title %}Apply for {{ offer.Title }} - Mosla Pioneers{% endblock %}

{% block head_extra %}
    {{ super() }}
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <style>
      .invalid-feedback { display: none; }
      .is-invalid + .invalid-feedback,
      .is-invalid ~ .invalid-feedback { display: block; }

      details > summary { list-style: none; }
      details > summary::-webkit-details-marker { display: none; }
      details summary .accordion-arrow { transition: transform 0.2s; }
      details[open] summary .accordion-arrow { transform: rotate(90deg); }

      /* Custom styles for the recorder */
      #recorder-container .recorder-button {
        background-color: #f3f4f6;
        color: #111827;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-weight: 500;
        border: 1px solid #d1d5db;
        transition: background-color 0.2s;
      }
      #recorder-container .recorder-button:hover {
        background-color: #e5e7eb;
      }
      #recorder-container .recorder-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #recordButton.is-recording {
        background-color: #ef4444;
        color: white;
        border-color: #ef4444;
      }
      #recording-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      #recording-status .recording-dot {
        width: 8px;
        height: 8px;
        background-color: #ef4444;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.2; }
        100% { opacity: 1; }
      }

    </style>
{% endblock %}

{% block content %}
<div class="job-detail-page-wrapper">
    <main id="mainContent" class="relative z-10 bg-transparent py-8 sm:py-12">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            {% if offer and current_user.is_authenticated and current_user.role_type == 'Candidate' %}
                <form id="applicationForm" method="POST" enctype="multipart/form-data" class="bg-card/90 backdrop-blur-sm p-6 sm:p-8 lg:p-10 rounded-2xl shadow-xl space-y-8 border border-border/50">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-heading">Apply for {{ offer.Title }}</h2>
                        <p class="mt-2 text-sm text-text-muted">Please complete the form below. Fields marked with <span class="text-danger-500">*</span> are required. <a href="{{ url_for('job_board_bp.job_detail', offer_id=offer.OfferID) }}" class="font-medium text-primary hover:text-primary-darker">View job details again</a>.</p>
                    </div>

                    <div id="formErrorMessages" class="hidden rounded-md bg-danger/10 p-4 ring-1 ring-inset ring-danger/20">
                        <div class="flex">
                            <div class="flex-shrink-0"><svg class="h-5 w-5 text-danger-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg></div>
                            <div class="ml-3"><div id="formErrorContent" class="text-sm text-danger-700 dark:text-danger-300"></div></div>
                        </div>
                    </div>

                    <div class="border-t border-border pt-8 space-y-6">
                        <!-- Personal Information Section -->
                        <div class="space-y-6">
                             <div>
                                <label for="fullName" class="block text-sm font-medium leading-6 text-text">Full Name <span class="text-danger-500">*</span></label>
                                <div class="mt-2"><input type="text" id="fullName" name="full_name" value="{{ form_data.get('full_name', '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_full_name"></p>
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium leading-6 text-text">Email <span class="text-danger-500">*</span></label>
                                <div class="mt-2"><input type="email" id="email" name="email" value="{{ form_data.get('email', '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_email"></p>
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-sm font-medium leading-6 text-text">Phone Number <span class="text-danger-500">*</span></label>
                                <div class="mt-2"><input type="tel" id="phoneNumber" name="phone_number" value="{{ form_data.get('phone_number', '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_phone_number"></p>
                            </div>
                            <div>
                                <label for="referralCode" class="block text-sm font-medium leading-6 text-text">Referral Code (Optional)</label>
                                <div class="mt-2"><input type="text" id="referralCode" name="referral_code" value="{{ form_data.get('referral_code', '') }}" placeholder="e.g., JOHN123" class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                <div id="referralCodeFeedback" class="text-sm mt-2"></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_referral_code"></p>
                            </div>
                        </div>

                        <!-- Application Questions Section -->
                        <div class="space-y-6 pt-6 border-t border-border">
                             <div>
                                <label for="candidateQuestions" class="block text-sm font-medium leading-6 text-text">Why are you interested in this role? <span class="text-danger-500">*</span></label>
                                <div class="mt-2"><textarea id="candidateQuestions" name="candidateQuestions" required rows="4" class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input">{{ form_data.get('candidateQuestions', '') }}</textarea></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_candidateQuestions"></p>
                            </div>
                        </div>

                        <!-- File Uploads Section -->
                        <div class="space-y-6 pt-6 border-t border-border">
                            <div class="bg-background/50 p-4 rounded-lg border border-border">
                                <h3 class="text-sm font-medium leading-6 text-text">Your Voice Introduction <span class="text-danger-500">*</span></h3>
                                <p class="mt-1 text-xs text-text-muted">In a 60-90 second audio file, introduce yourself and briefly answer: 1. Why a call center role? 2. What makes you a great fit?</p>

                                <!-- NEW: Voice Recorder UI -->
                                <div id="recorder-container" class="mt-4 p-4 border border-dashed border-border/70 rounded-lg">
                                    <div id="recording-controls" class="flex items-center gap-4">
                                        <button type="button" id="recordButton" class="recorder-button">Record</button>
                                        <button type="button" id="stopButton" class="recorder-button" disabled>Stop</button>
                                        <div id="recording-status" class="hidden">
                                            <span class="recording-dot"></span>
                                            <span class="text-sm font-medium text-text">Recording...</span>
                                        </div>
                                    </div>
                                    <div id="audio-playback-area" class="mt-4 hidden">
                                        <p class="text-sm font-medium text-text mb-2">Your Recording:</p>
                                        <audio id="audioPreview" controls class="w-full"></audio>
                                        <button type="button" id="resetRecordingButton" class="mt-2 text-sm text-danger-600 hover:text-danger-800">Record again</button>
                                    </div>
                                    <div id="recorder-error" class="hidden mt-2 text-sm text-danger-600"></div>
                                </div>
                                <!-- END: Voice Recorder UI -->

                                <!-- Fallback File Upload -->
                                <div class="mt-4">
                                    <label for="voice_note_file" class="block text-xs font-medium text-text-muted">Or upload an audio file:</label>
                                    <div class="mt-1">
                                        <input type="file" id="voice_note_file" name="voice_note_file" accept=".mp3,.m4a,.wav,.webm,.ogg" class="block w-full text-sm text-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer">
                                    </div>
                                    <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_voice_note_file"></p>
                                </div>


                                <!-- Detailed instructions accordion -->
                                <details class="mt-4">
                                    <summary class="cursor-pointer text-sm font-medium text-primary hover:text-primary-darker flex items-center gap-2">
                                        <svg class="accordion-arrow w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                        Need help recording or uploading? Click here.
                                    </summary>
                                    <div class="mt-3 pl-6 border-l-2 border-border/50 text-sm text-text-muted space-y-4">
                                        <div>
                                            <h4 class="font-semibold text-text">Recommended Apps:</h4>
                                            <ul class="list-disc list-outside pl-5 mt-1">
                                                <li><strong class="text-text">iOS (iPhone):</strong> Use the built-in <strong class="text-text">"Voice Memos"</strong> app.</li>
                                                <li><strong class="text-text">Android:</strong> Use the built-in <strong class="text-text">"Recorder"</strong> or "Voice Recorder" app.</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-text">Steps to Record & Upload:</h4>
                                            <ol class="list-decimal list-outside pl-5 mt-1 space-y-2">
                                                <li><strong>Record Your Audio:</strong> Open the recommended app on your phone, press record, and speak clearly into your phone's microphone for 60-90 seconds.</li>
                                                <li><strong>Save & Find Your File (iOS):</strong>
                                                    <ul class="list-disc list-outside pl-5 mt-1">
                                                        <li>After recording, tap "Done" and name your file (e.g., "My Application Intro").</li>
                                                        <li>Tap the "..." (more options) button on your recording.</li>
                                                        <li>Select <strong class="text-text">"Save to Files"</strong> and choose a location you'll remember, like "On My iPhone" or "iCloud Drive".</li>
                                                    </ul>
                                                </li>
                                                <li><strong>Save & Find Your File (Android):</strong>
                                                     <ul class="list-disc list-outside pl-5 mt-1">
                                                        <li>Stop the recording and save it. It's usually saved automatically in a "Recordings" or "Sounds" folder inside your phone's internal storage.</li>
                                                    </ul>
                                                </li>
                                                <li><strong>Upload to the Form:</strong> On this page, tap the "Choose File" button above and navigate to where you saved your audio file to select it.</li>
                                            </ol>
                                        </div>
                                    </div>
                                </details>
                            </div>

                            <div class="bg-background/50 p-4 rounded-lg border border-border">
                                <label for="cv_file" class="block text-sm font-medium leading-6 text-text">Upload Your CV <span class="text-danger-500">*</span></label>
                                <p class="mt-1 text-xs text-text-muted">Please upload your most recent CV in .pdf, .doc, or .docx format.</p>
                                <div class="mt-3"><input type="file" id="cv_file" name="cv_file" accept=".pdf,.doc,.docx" required class="block w-full text-sm text-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer"></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_cv_file"></p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="hiddenSubmitBtn" class="hidden">Submit</button>
                </form>
            {% else %}
                 <div class="bg-card/90 backdrop-blur-sm p-10 rounded-2xl shadow-xl text-center border border-border/50">
                    <h3 class="text-xl font-bold text-heading">Application Error</h3>
                    <div class="mt-4 rounded-md bg-danger/10 p-4 ring-1 ring-inset ring-danger/20">
                        <p class="text-sm text-danger-700 dark:text-danger-300">There was a problem loading the application form. You must be logged in as a Candidate to apply.</p>
                    </div>
                    <a href="{{ url_for('job_board_bp.job_detail', offer_id=offer.OfferID) if offer else url_for('job_board_bp.job_offers_list') }}" class="mt-6 inline-block rounded-lg bg-primary px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-primary-darker">Return to Job Details</a>
                </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- Sticky Send Application Bar -->
<div id="stickyBar" class="fixed bottom-0 left-0 w-full bg-gray-900/90 backdrop-blur-lg border-t border-white/10 shadow-2xl z-50">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between gap-4 py-3">
            <div class="text-left"><p class="text-sm text-gray-300">Ready to submit?</p></div>
            <div class="flex-shrink-0 w-full sm:w-auto"><button type="button" id="sendBtn" class="w-full rounded-lg bg-primary px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-primary-darker focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-75">Send Application</button></div>
        </div>
    </div>
</div>

{% endblock %}

{% block page_scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const applicationForm = document.getElementById('applicationForm');
        if (!applicationForm) return;

        // --- NEW: Voice Recorder Logic ---
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const audioPreview = document.getElementById('audioPreview');
        const playbackArea = document.getElementById('audio-playback-area');
        const recordingControls = document.getElementById('recording-controls');
        const resetRecordingButton = document.getElementById('resetRecordingButton');
        const recordingStatus = document.getElementById('recording-status');
        const recorderError = document.getElementById('recorder-error');
        const voiceNoteFileInput = document.getElementById('voice_note_file');

        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;

        const showError = (message) => {
            recorderError.textContent = message;
            recorderError.classList.remove('hidden');
        };

        const resetRecorderState = () => {
            recordButton.disabled = false;
            recordButton.classList.remove('is-recording');
            recordButton.textContent = 'Record';
            stopButton.disabled = true;
            recordingStatus.classList.add('hidden');
            playbackArea.classList.add('hidden');
            recorderError.classList.add('hidden');
            if (audioPreview.src) {
                URL.revokeObjectURL(audioPreview.src);
            }
            audioPreview.src = null;
            audioChunks = [];
            recordedBlob = null;
            voiceNoteFileInput.value = ''; // Clear file input if they re-record
        };

        recordButton.addEventListener('click', async () => {
            resetRecorderState();
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Recording is not supported by your browser.');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recordButton.disabled = true;
                recordButton.classList.add('is-recording');
                recordButton.textContent = 'Recording...';
                stopButton.disabled = false;
                recordingStatus.classList.remove('hidden');

                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioPreview.src = audioUrl;

                    playbackArea.classList.remove('hidden');
                    recordButton.disabled = false;
                    recordButton.textContent = 'Record Again';
                    stopButton.disabled = true;
                    recordingStatus.classList.add('hidden');

                    // Stop all media tracks to turn off the microphone light
                    stream.getTracks().forEach(track => track.stop());
                });
            } catch (err) {
                showError('Microphone access was denied. Please enable it in your browser settings.');
                console.error("Error accessing media devices.", err);
                resetRecorderState();
            }
        });

        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        });

        resetRecordingButton.addEventListener('click', resetRecorderState);

        // --- End of Voice Recorder Logic ---


        const sendBtn = document.getElementById('sendBtn');
        const hiddenSubmitBtn = document.getElementById('hiddenSubmitBtn');

        if (sendBtn && hiddenSubmitBtn) {
            sendBtn.addEventListener('click', () => {
                hiddenSubmitBtn.click();
            });
        }

        applicationForm.action = "{{ url_for('job_board_bp.submit_application_form', offer_id=offer.OfferID) }}";

        applicationForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Basic client-side validation logic can remain here...

            const formData = new FormData(applicationForm);
            const formErrorMessagesDiv = document.getElementById('formErrorMessages');
            const formErrorContent = document.getElementById('formErrorContent');

            // --- IMPROVED: Append recorded voice note if it exists ---
            if (recordedBlob) {
                // If a recording was made, use it. Give it a standard name.
                // The backend will receive this as if it were an uploaded file.
                formData.set('voice_note_file', recordedBlob, 'voice-introduction.webm');
            }
            // If recordedBlob is null, the FormData will use the file from
            // the <input type="file"> if the user selected one.

            sendBtn.disabled = true;
            sendBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(applicationForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' }
                });

                if (response.ok) {
                    const result = await response.json().catch(() => null);

                    if (result && result.status === 'success') {
                        alert(result.message || "Application submitted successfully!");
                        window.location.href = result.redirect_url || "{{ url_for('job_board_bp.job_offers_list') }}";
                    } else if (result && result.status === 'error') {
                        let errorHtml = `Please correct the following errors:<ul>${Object.values(result.errors || {}).map(e => `<li>- ${e}</li>`).join('')}</ul>`;
                        if (result.message && !result.errors) {
                            errorHtml = result.message;
                        }
                        formErrorContent.innerHTML = errorHtml;
                        formErrorMessagesDiv.classList.remove('hidden');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        throw new Error('Received an unexpected successful response from the server.');
                    }
                } else {
                    const result = await response.json().catch(() => null);
                    if (result && result.errors) {
                        let errorHtml = `Please correct the following errors:<ul>${Object.values(result.errors).map(e => `<li>- ${e}</li>`).join('')}</ul>`;
                        formErrorContent.innerHTML = errorHtml;
                    } else {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    formErrorMessagesDiv.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Submission failed:", error);
                formErrorContent.innerHTML = "An unexpected error occurred. Please check your connection and try again. If the issue persists, contact support.";
                formErrorMessagesDiv.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Application';
            }
        });

        // The rest of your JS for referral code, sticky bar, etc. can remain here.
    });
    </script>
{% endblock %}

{# Remove footer from this specific page #}
{% block footer %}{% endblock footer %}