{% extends "Website/base.html" %}

{% block title %}Apply for {{ offer.Title }} - Mosla Pioneers{% endblock %}

{% block head_extra %}
    {{ super() }}
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <style>
      .invalid-feedback { display: none; }
      .is-invalid + .invalid-feedback,
      .is-invalid ~ .invalid-feedback { display: block; }
    </style>
{% endblock %}

{% block content %}
<div class="job-detail-page-wrapper">
    <main id="mainContent" class="relative z-10 bg-transparent py-8 sm:py-12">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            {% if offer and current_user.is_authenticated and current_user.role_type == 'Candidate' %}
                <div class="space-y-4 mb-8">
                    <h2 class="text-3xl sm:text-4xl font-bold text-heading text-center">Apply for {{ offer.Title }}</h2>
                    <p class="mt-2 text-base text-text-muted text-center">Complete the sections below to submit your application.</p>
                </div>
                
                <form id="applicationForm" method="POST" enctype="multipart/form-data" class="space-y-6">
                    
                    <div id="formErrorMessages" class="hidden rounded-lg bg-danger/10 p-4 ring-1 ring-inset ring-danger/20">
                        <div class="flex">
                            <div class="flex-shrink-0"><svg class="h-5 w-5 text-danger-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg></div>
                            <div class="ml-3"><div id="formErrorContent" class="text-sm text-danger-700 dark:text-danger-300"></div></div>
                        </div>
                    </div>

                    <!-- START: Bento Grid Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Main Info Box (Left/Large) -->
                        <div class="lg:col-span-2 bg-card/90 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-xl border border-border/50 space-y-8">
                            <!-- Personal Information Section -->
                            <div class="space-y-6">
                                <h3 class="text-lg font-semibold text-heading border-b border-border/50 pb-3">Personal Information</h3>
                                <div>
                                    <label for="fullName" class="block text-sm font-medium leading-6 text-text">Full Name <span class="text-danger-500">*</span></label>
                                    <div class="mt-2"><input type="text" id="fullName" name="full_name" value="{{ form_data.get('full_name', current_user.full_name or '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                    <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_full_name"></p>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium leading-6 text-text">Email <span class="text-danger-500">*</span></label>
                                    <div class="mt-2"><input type="email" id="email" name="email" value="{{ form_data.get('email', current_user.email or '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                    <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_email"></p>
                                </div>
                                <div>
                                    <label for="phoneNumber" class="block text-sm font-medium leading-6 text-text">Phone Number <span class="text-danger-500">*</span></label>
                                    <div class="mt-2"><input type="tel" id="phoneNumber" name="phone_number" value="{{ form_data.get('phone_number', current_user.phone_number or '') }}" required class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input"></div>
                                    <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_phone_number"></p>
                                </div>
                                <div>
                                    <label for="referralCode" class="block text-sm font-medium leading-6 text-text">Referral Code</label>
                                    <div class="mt-2"><input type="text" id="referralCode" name="referral_code" value="{{ form_data.get('referral_code', '') }}" placeholder="Enter code here..." oninput="validateReferralCode(this.value)" class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input uppercase"></div>
                                    <div id="referralCodeFeedback" class="text-sm mt-2 font-medium"></div>
                                    <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_referral_code"></p>
                                </div>
                            </div>
                            
                            <!-- Application Questions Section -->
                            <div class="space-y-6 pt-8 border-t border-border/50">
                                <h3 class="text-lg font-semibold text-heading border-b border-border/50 pb-3">Application Questions</h3>
                                <div>
                                    <label for="candidateQuestions" class="block text-sm font-medium leading-6 text-text">Why are you interested in this role? <span class="text-danger-500">*</span></label>
                                    <div class="mt-2"><textarea id="candidateQuestions" name="candidateQuestions" required rows="6" class="block w-full rounded-md border-0 py-2.5 text-text shadow-sm ring-1 ring-inset ring-input-border placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary bg-input">{{ form_data.get('candidateQuestions', '') }}</textarea></div>
                                    <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_candidateQuestions"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Side Column (Right/Small) -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-card/90 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-border/50">
                                <h3 class="text-base font-semibold text-heading">Job Details</h3>
                                <p class="text-sm text-text-muted mt-2">You are applying for the <strong class="text-text">{{ offer.Title }}</strong> position.</p>
                                <a href="{{ url_for('job_board_bp.job_detail', offer_id=offer.OfferID) }}" class="mt-4 inline-block font-medium text-sm text-primary hover:text-primary-darker">View full job details â†’</a>
                            </div>
                            <div class="bg-card/90 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-border/50">
                                <h3 class="text-base font-semibold leading-6 text-heading">Upload Your CV <span class="text-danger-500">*</span></h3>
                                <p class="mt-1 text-xs text-text-muted">Please upload your most recent CV in .pdf, .doc, or .docx format.</p>
                                <div class="mt-4"><input type="file" id="cv_file" name="cv_file" accept=".pdf,.doc,.docx" required class="block w-full text-sm text-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer"></div>
                                <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_cv_file"></p>
                            </div>
                        </div>

                        <!-- Voice Introduction Box (Full Width) -->
                        <div class="lg:col-span-3 bg-card/90 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-xl border border-border/50">
                             <h3 class="text-lg font-semibold leading-6 text-heading">Your Voice Introduction <span class="text-danger-500">*</span></h3>
                             <p class="mt-1 text-sm text-text-muted">
                                Record a voice introduction (up to 5 minutes). 
                                <strong id="voice-prompt-text">Please introduce yourself and explain your interest in this role.</strong>
                             </p>
                            <div id="recorder-container" class="mt-4 p-4 border border-dashed border-border/70 rounded-lg space-y-4">
                                <div class="flex items-center justify-between flex-wrap gap-4">
                                    <div id="recorder-controls" class="flex items-center gap-3">
                                        <button type="button" id="recordButton" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 4a.5.5 0 00-1 0v6a4.5 4.5 0 009 0V4a.5.5 0 00-1 0v6a3.5 3.5 0 01-7 0V4z" /></svg>
                                            <span>Record</span>
                                        </button>
                                        <button type="button" id="stopButton" class="hidden flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-full hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><rect width="10" height="10" x="5" y="5" rx="1" /></svg>
                                            <span>Stop</span>
                                        </button>
                                    </div>
                                    <div id="recording-status" class="hidden flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                        <span id="recording-state-text">Recording...</span>
                                        <div class="flex items-center gap-2 font-mono text-gray-500 dark:text-gray-400">
                                            <span id="timer">00:00</span>
                                            <span>/</span>
                                            <span id="estimated-size">0 KB</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="audio-playback-area" class="hidden pt-4 border-t border-border/50 space-y-3">
                                    <p class="text-sm font-medium text-text">Your recording is ready:</p>
                                    <audio id="audioPreview" controls class="w-full"></audio>
                                    <button type="button" id="deleteRecordingButton" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-gray-700 bg-transparent border border-gray-300 rounded-full hover:bg-gray-100 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.323 4.677a.75.75 0 0 0-1.06-1.06l-1.12 1.12A6.5 6.5 0 0 0 10 4.5a6.5 6.5 0 0 0-6.5 6.5.75.75 0 0 0 1.5 0A5 5 0 0 1 10 6a5.002 5.002 0 0 1 4.132 2.318l-1.182-1.182a.75.75 0 0 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.06 0l2.5-2.5zM4.677 15.323a.75.75 0 0 0 1.06 1.06l1.12-1.12A6.5 6.5 0 0 0 10 15.5a6.5 6.5 0 0 0 6.5-6.5.75.75 0 0 0-1.5 0A5 5 0 0 1 10 14a5.002 5.002 0 0 1-4.132-2.318l1.182 1.182a.75.75 0 0 0 1.06-1.061l-2.5-2.5a.75.75 0 0 0-1.06 0l-2.5 2.5z" clip-rule="evenodd" /></svg>
                                        Re-record
                                    </button>
                                </div>
                                <div id="recorder-error" class="hidden mt-2 text-sm text-red-600 dark:text-red-500"></div>
                            </div>
                            <p class="invalid-feedback mt-2 text-sm text-danger-600" id="error_voice_note_file"></p>
                        </div>
                    </div>
                    <!-- END: Bento Grid Layout -->

                    <div class="pt-6 flex justify-end">
                        <button type="submit" id="sendBtn" class="w-full sm:w-auto rounded-lg bg-primary px-8 py-3 text-base font-semibold text-white shadow-sm hover:bg-primary-darker focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-75 disabled:cursor-wait">
                            Send Application
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="bg-card/90 backdrop-blur-sm p-10 rounded-2xl shadow-xl text-center border border-border/50">
                    <h3 class="text-xl font-bold text-heading">Application Error</h3>
                    <div class="mt-4 rounded-md bg-danger/10 p-4 ring-1 ring-inset ring-danger/20">
                        <p class="text-sm text-danger-700 dark:text-danger-300">There was a problem loading the application form. You must be logged in as a Candidate to apply.</p>
                    </div>
                    <a href="{{ url_for('job_board_bp.job_detail', offer_id=offer.OfferID) if offer else url_for('job_board_bp.job_offers_list') }}" class="mt-6 inline-block rounded-lg bg-primary px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-primary-darker">Return to Job Details</a>
                </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block page_scripts %}
    {{ super() }}
    <script src="https://unpkg.com/mic-recorder-to-mp3"></script>

    <script>
    // Referral Code Validation Script
    let debounceTimer;
    async function validateReferralCode(code) {
        const feedbackEl = document.getElementById('referralCodeFeedback');
        const codeInput = document.getElementById('referralCode');
        clearTimeout(debounceTimer);
        if (!code.trim()) {
            feedbackEl.innerHTML = '';
            return;
        }
        debounceTimer = setTimeout(async () => {
            feedbackEl.innerHTML = '<span class="text-text-muted">Checking...</span>';
            try {
                const response = await fetch("{{ url_for('job_board_bp.validate_referral_code_api') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''},
                    body: JSON.stringify({ referral_code: code })
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    let successMessage = `<i class="bi bi-check-circle-fill"></i> Referred by: <strong>${result.recruiter_name}</strong>`;
                    if (result.team_name) {
                        successMessage += ` (Team: ${result.team_name})`;
                    }
                    feedbackEl.innerHTML = `<span class="text-success-600">${successMessage}</span>`;
                    codeInput.classList.remove('ring-danger-500');
                } else {
                    feedbackEl.innerHTML = `<span class="text-danger-600"><i class="bi bi-x-circle-fill"></i> ${result.message || 'Invalid code'}</span>`;
                    codeInput.classList.add('ring-danger-500');
                }
            } catch (error) {
                feedbackEl.innerHTML = `<span class="text-danger-600">Could not validate code.</span>`;
                codeInput.classList.add('ring-danger-500');
            }
        }, 400);
    }

    document.addEventListener('DOMContentLoaded', () => {
        
        // --- DYNAMIC VOICE PROMPT LOGIC ---
        const jobCategory = "{{ category_name|e|default('Unknown') }}";
        const promptElement = document.getElementById('voice-prompt-text');

        // This is where you define the prompts for each category.
        const voicePrompts = {
            'Call Center': 'Introduce yourself and briefly answer: 1. Why are you interested in a call center role? 2. What makes you a great fit for customer service?',
            'Sales': 'Introduce yourself and briefly answer: 1. What is your greatest sales achievement? 2. Why are you passionate about a career in sales?',
            'Customer Service': 'Introduce yourself and briefly answer: 1. Describe a time you handled a difficult customer. 2. What does excellent customer service mean to you?'
            // Add more categories here, e.g., 'IT Support': 'Your new prompt here'
        };

        const defaultPrompt = 'Introduce yourself and tell us why you are the best candidate for this role.';
        
        if (promptElement) {
            promptElement.textContent = voicePrompts[jobCategory] || defaultPrompt;
        }
        // --- END DYNAMIC VOICE PROMPT LOGIC ---

        const applicationForm = document.getElementById('applicationForm');
        if (!applicationForm) return;

        // Voice Recorder Elements
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const audioPreview = document.getElementById('audioPreview');
        const playbackArea = document.getElementById('audio-playback-area');
        const deleteRecordingButton = document.getElementById('deleteRecordingButton');
        const recordingStatus = document.getElementById('recording-status');
        const recordingStateText = document.getElementById('recording-state-text');
        const timerEl = document.getElementById('timer');
        const sizeEl = document.getElementById('estimated-size');
        const recorderError = document.getElementById('recorder-error');
        let recorder = null;
        let compressedAudioBlob = null;
        let timerInterval = null;
        const MAX_RECORDING_SECONDS = 300;
        const MP3_BITRATE_KBPS = 64;
        const showError = (message) => { recorderError.textContent = message; recorderError.classList.remove('hidden'); };
        const formatTime = (seconds) => { const minutes = Math.floor(seconds / 60); const secs = seconds % 60; return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; };
        function formatBytes(bytes, decimals = 1) { if (!+bytes) return '0 KB'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`; }
        const updateUI = (state) => {
            recorderError.classList.add('hidden');
            const controls = document.getElementById('recorder-controls');
            if (state === 'idle') {
                controls.classList.remove('hidden');
                recordButton.classList.remove('hidden');
                stopButton.classList.add('hidden');
                recordingStatus.classList.add('hidden');
                playbackArea.classList.add('hidden');
                if (audioPreview.src) { URL.revokeObjectURL(audioPreview.src); audioPreview.src = ""; }
            } else if (state === 'recording') {
                controls.classList.remove('hidden');
                recordButton.classList.add('hidden');
                stopButton.classList.remove('hidden');
                recordingStatus.classList.remove('hidden');
                recordingStateText.textContent = "Recording...";
                playbackArea.classList.add('hidden');
            } else if (state === 'processing') {
                controls.classList.add('hidden');
                recordingStatus.classList.remove('hidden');
                recordingStateText.textContent = "Compressing audio...";
                playbackArea.classList.add('hidden');
            } else if (state === 'preview') {
                controls.classList.add('hidden');
                recordingStatus.classList.add('hidden');
                playbackArea.classList.remove('hidden');
            }
        };
        const resetRecorder = () => {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            timerEl.textContent = '00:00';
            sizeEl.textContent = '0 KB';
            compressedAudioBlob = null;
            updateUI('idle');
        };
        try {
            recorder = new MicRecorder({ bitRate: MP3_BITRATE_KBPS });
        } catch (e) {
            console.error("Failed to initialize recorder", e);
            showError("Audio recording is not supported on this browser.");
            recordButton.disabled = true;
        }
        recordButton.addEventListener('click', () => {
            if (!recorder) return;
            resetRecorder();
            recorder.start().then(() => {
                updateUI('recording');
                let seconds = 0;
                timerInterval = setInterval(() => {
                    seconds++;
                    timerEl.textContent = formatTime(seconds);
                    const estimatedBytes = (MP3_BITRATE_KBPS / 8) * 1000 * seconds;
                    sizeEl.textContent = formatBytes(estimatedBytes);
                    if (seconds >= MAX_RECORDING_SECONDS) {
                        stopButton.click();
                    }
                }, 1000);
            }).catch((e) => {
                console.error("Recording start failed:", e);
                showError('Microphone access was denied. Please enable it in your browser settings.');
                resetRecorder();
            });
        });
        stopButton.addEventListener('click', () => {
            if (!recorder) return;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            updateUI('processing');
            recorder.stop().getMp3().then(([buffer, blob]) => {
                compressedAudioBlob = blob;
                audioPreview.src = URL.createObjectURL(blob);
                updateUI('preview');
            }).catch((e) => {
                console.error("MP3 conversion failed:", e);
                showError("Sorry, there was an error processing your audio. Please try again.");
                resetRecorder();
            });
        });
        deleteRecordingButton.addEventListener('click', resetRecorder);
        const sendBtn = document.getElementById('sendBtn');
        applicationForm.action = "{{ url_for('job_board_bp.submit_application_form', offer_id=offer.OfferID) }}";
        applicationForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(applicationForm);
            if (compressedAudioBlob) {
                formData.set('voice_note_file', compressedAudioBlob, 'voice-introduction.mp3'); 
            }
            const formErrorMessagesDiv = document.getElementById('formErrorMessages');
            const formErrorContent = document.getElementById('formErrorContent');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Submitting...';
            formErrorMessagesDiv.classList.add('hidden');
            document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
            try {
                const response = await fetch(applicationForm.action, { 
                    method: 'POST', 
                    body: formData, 
                    headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' }
                });
                const result = await response.json().catch(() => ({ status: 'error', message: `Server returned a non-JSON response (Status: ${response.status}). Please contact support.` }));
                if (response.ok && result.status === 'success') {
                    alert(result.message || "Application submitted successfully!");
                    window.location.href = result.redirect_url || "{{ url_for('job_board_bp.job_offers_list') }}";
                } else {
                    let errorHtml = result.message || 'An unknown error occurred.';
                    if (result.errors) {
                         const errorList = Object.entries(result.errors).map(([key, msg]) => {
                            const errorEl = document.getElementById(`error_${key}`);
                            if(errorEl) errorEl.textContent = msg;
                            return `<li>- ${msg}</li>`;
                         }).join('');
                         errorHtml = `Please correct the following errors:<ul>${errorList}</ul>`;
                    }
                    formErrorContent.innerHTML = errorHtml;
                    formErrorMessagesDiv.classList.remove('hidden');
                    formErrorMessagesDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } catch (error) {
                console.error("Submission failed:", error);
                formErrorContent.innerHTML = "A network error occurred. Please check your connection and try again.";
                formErrorMessagesDiv.classList.remove('hidden');
                formErrorMessagesDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Application';
            }
        });
    });
    </script>
{% endblock %}

{# Remove footer from this specific page #}
{% block footer %}{% endblock footer %}