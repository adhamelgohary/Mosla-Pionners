{% extends 'agency_staff_portal/staff_base.html' %}

{% block staff_title %}{{ title }}{% endblock %}

{% block staff_page_title %}
    <i class="bi bi-calendar-week-fill"></i> {{ title }}
{% endblock %}

{% block staff_content %}
<div class="max-w-4xl mx-auto">
    <!-- 
        This is the main form for the "Save All" functionality.
        The action points to the `update_company_schedules` route.
    -->
    <form method="POST" action="{{ url_for('.update_company_schedules', company_id=company_id) }}" 
          x-data="{ 
              // This is the CRITICAL part.
              // 'schedules' is initialized with the JSON data from your Python backend.
              // This creates a client-side array of objects that Alpine.js can work with.
              schedules: {{ schedules|tojson|safe if schedules else [] }},
              
              // This function adds a NEW, empty slot to the client-side 'schedules' array.
              addSchedule() {
                  this.schedules.push({ 
                      ScheduleID: null, // New slots have no ID yet
                      DayOfWeek: '', 
                      StartTime: '09:00', 
                      EndTime: '17:00' 
                  });
              }
          }">
        
        <div class="bg-white dark:bg-slate-800 shadow-md rounded-lg border border-gray-200 dark:border-slate-700">
            <div class="p-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Set the standard weekly days and times this company is available for interviews. Add or remove slots and click "Save Schedule" to apply all changes.</p>

                <!-- Schedule Rows Container -->
                <div class="space-y-4">
                    <template x-if="schedules.length === 0">
                        <div class="text-center border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-lg p-8">
                            <p class="text-gray-500 dark:text-gray-400">No schedules defined for this company yet.</p>
                            <button type="button" @click="addSchedule()" class="mt-4 btn-secondary">
                                <i class="bi bi-plus-circle-fill mr-2"></i> Add First Schedule
                            </button>
                        </div>
                    </template>

                    <!-- This template is the blueprint for each row -->
                    <template x-for="(schedule, index) in schedules" :key="schedule.ScheduleID || 'new-' + index">
                        <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                            <!-- Day of Week -->
                            <div class="flex-1">
                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Day</label>
                                <!-- x-model correctly binds the dropdown's selected value to schedule.DayOfWeek -->
                                <select name="day" x-model="schedule.DayOfWeek" class="form-input w-full mt-1">
                                    <option value="">Select Day</option>
                                    {% for day in day_options %}
                                        <option value="{{ day }}">{{ day }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Start Time -->
                            <div class="flex-1">
                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Start Time</label>
                                <!-- x-model correctly binds the input's value to schedule.StartTime -->
                                <input type="time" name="start_time" x-model="schedule.StartTime" class="form-input w-full mt-1">
                            </div>
                            <!-- End Time -->
                            <div class="flex-1">
                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">End Time</label>
                                <!-- x-model correctly binds the input's value to schedule.EndTime -->
                                <input type="time" name="end_time" x-model="schedule.EndTime" class="form-input w-full mt-1">
                            </div>
                            <!-- Delete Button Logic -->
                            <div class="pt-5">
                                <!-- If the slot has an ID, it's an existing one from the DB -->
                                <template x-if="schedule.ScheduleID">
                                    <form :action="'/staff-portal/job-offers/schedules/delete/' + schedule.ScheduleID" method="POST" onsubmit="return confirm('Are you sure you want to delete this time slot? This is permanent.');">
                                        <button type="submit" class="text-gray-400 hover:text-red-500 transition" title="Delete Saved Slot">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </form>
                                </template>
                                <!-- If the slot has no ID, it's a new one added via Alpine -->
                                <template x-if="!schedule.ScheduleID">
                                    <button type="button" @click="schedules.splice(index, 1)" class="text-gray-400 hover:text-red-500 transition" title="Remove New Slot">
                                        <i class="bi bi-x-circle-fill"></i>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="mt-6">
                    <button type="button" @click="addSchedule()" class="btn-secondary">
                        <i class="bi bi-plus-lg mr-2"></i> Add Another Day
                    </button>
                </div>
            </div>
            
            <!-- Form Actions Footer -->
            <div class="bg-gray-50 dark:bg-slate-700/50 px-6 py-4 border-t border-gray-200 dark:border-slate-700 flex justify-end gap-3">
                <a href="{{ url_for('.list_all_job_offers') }}" class="btn-secondary">Cancel</a>
                <button type="submit" class="btn-primary">
                    <i class="bi bi-save-fill mr-1"></i> Save All Changes
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}