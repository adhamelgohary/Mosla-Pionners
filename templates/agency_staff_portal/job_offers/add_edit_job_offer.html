{# templates/agency_staff_portal/job_offers/add_edit_job_offer.html #}
{% extends "agency_staff_portal/staff_base.html" %}

{% block staff_title %}{{ title }}{% endblock %}
{% block staff_page_title %}{{ title }}{% endblock %}

{% block staff_content %}
<div class="form-container" style="max-width: 900px; margin: auto;">
    <form method="POST"
          action="{% if is_editing_live %}{{ url_for('job_offer_mgmt_bp.edit_live_job_offer', offer_id=offer_id) }}{% else %}{{ url_for('job_offer_mgmt_bp.staff_direct_create_job_offer') }}{% endif %}">

        {% if is_editing_live %}
            <input type="hidden" name="original_title_hidden" value="{{ original_title_hidden or form_data.get('position-title', '') }}">
        {% endif %}

        <div class="form-grid">

            <!-- Company & Category -->
            <div class="form-group">
                <label for="company_id">Company <span class="required">*</span></label>
                <select id="company_id" name="company_id" class="{{ 'is-invalid' if errors.get('company_id') }}" required>
                    <option value="">Select Company...</option>
                    {% for company in companies %}
                    <option value="{{ company.CompanyID }}" {% if form_data.get('company_id')|string == company.CompanyID|string or form_data.get('CompanyID')|string == company.CompanyID|string %}selected{% endif %}>
                        {{ company.CompanyName }}
                    </option>
                    {% endfor %}
                </select>
                {% if errors.get('company_id') %}<div class="invalid-feedback">{{ errors.get('company_id') }}</div>{% endif %}
            </div>
            <div class="form-group">
                <label for="category_id">Job Category <span class="required">*</span></label>
                <select id="category_id" name="category_id" class="{{ 'is-invalid' if errors.get('category_id') }}" required>
                    <option value="">Select Category...</option>
                    {% for category in categories %}
                    <option value="{{ category.CategoryID }}" {% if form_data.get('category_id')|string == category.CategoryID|string or form_data.get('CategoryID')|string == category.CategoryID|string %}selected{% endif %}>
                        {{ category.CategoryName }}
                    </option>
                    {% endfor %}
                </select>
                {% if errors.get('category_id') %}<div class="invalid-feedback">{{ errors.get('category_id') }}</div>{% endif %}
            </div>

            <!-- Position Title -->
            <div class="form-group full-width">
                <label for="position-title">Position / Job Title <span class="required">*</span></label>
                <input type="text" id="position-title" name="position-title" placeholder="e.g., Senior Customer Service Agent"
                       value="{{ form_data.get('position-title', '') }}" required class="{{ 'is-invalid' if errors.get('title') }}">
                {% if errors.get('title') %}<div class="invalid-feedback">{{ errors.get('title') }}</div>{% endif %}
            </div>

            <!-- English Level & Candidate Count -->
            <div class="form-group">
                <label for="english-level">Required English Level <span class="required">*</span></label>
                <select id="english-level" name="english-level" required>
                    <option value="" disabled {% if not form_data.get('english-level') %}selected{% endif %}>Select level...</option>
                    {% set el = form_data.get('english-level') %}
                    <option value="B1" {% if el == 'B1' %}selected{% endif %}>B1 (Intermediate)</option>
                    <option value="B1+" {% if el == 'B1+' %}selected{% endif %}>B1+ (Intermediate)</option>
                    <option value="B2" {% if el == 'B2' %}selected{% endif %}>B2 (Upper-Intermediate)</option>
                    <option value="B2+" {% if el == 'B2+' %}selected{% endif %}>B2+ (Fluent)</option>
                    <option value="C1" {% if el == 'C1' %}selected{% endif %}>C1 (Advanced)</option>
                    <option value="C2" {% if el == 'C2' %}selected{% endif %}>C2 (Proficient)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="candidate-count">Number of Candidates Needed <span class="required">*</span></label>
                <input type="number" id="candidate-count" name="candidate-count" placeholder="e.g., 10" min="1" required
                       value="{{ form_data.get('candidate-count', '1') }}">
            </div>

            <!-- Location & Salary -->
            <div class="form-group">
                <label for="location">Work Site Location (if On-site)</label>
                <input type="text" id="location" name="location" value="{{ form_data.get('location', form_data.get('Location', '')) }}" placeholder="e.g., Maadi, Cairo">
            </div>
             <div class="form-group">
                <label for="salary">Salary (Net)</label>
                 <input type="number" step="0.01" id="salary" name="salary" placeholder="e.g., 8000" class="{{ 'is-invalid' if errors.get('salary') }}"
                        value="{{ form_data.get('salary', '') }}">
                 {% if errors.get('salary') %}<div class="invalid-feedback">{{ errors.get('salary') }}</div>{% endif %}
            </div>

            <!-- Graduation & Nationality -->
            <div class="form-group">
                <label for="grad-status">Graduation Status <span class="required">*</span></label>
                <select id="grad-status" name="grad-status" required>
                    <option value="" disabled {% if not form_data.get('grad-status') %}selected{% endif %}>Select status...</option>
                    {% set gs = form_data.get('grad-status') %}
                    <option value="Graduate" {% if gs == 'Graduate' %}selected{% endif %}>Graduate</option>
                    <option value="Undergraduate" {% if gs == 'Undergraduate' %}selected{% endif %}>Undergraduate</option>
                    <option value="Dropout" {% if gs == 'Dropout' %}selected{% endif %}>Drop out</option>
                    <option value="GapYear" {% if gs == 'GapYear' %}selected{% endif %}>Gap Year</option>
                </select>
            </div>
             <div class="form-group">
                <label for="nationality">Nationality <span class="required">*</span></label>
                <select id="nationality" name="nationality" required>
                    {% set n = form_data.get('nationality', 'Any') %}
                    <option value="Any" {% if n == 'Any' %}selected{% endif %}>Any</option>
                    <option value="Egyptian" {% if n == 'Egyptian' %}selected{% endif %}>Egyptian</option>
                    <option value="Foreigner" {% if n == 'Foreigner' %}selected{% endif %}>Foreigner</option>
                </select>
            </div>

            <!-- Radio Groups -->
            <div class="form-group">
                <label class="group-label">Work Location</label>
                <div class="choice-group">
                    <div class="choice-item"><input type="radio" id="loc-site" name="work_location" value="On-site" {% if form_data.get('work_location') == 'On-site' %}checked{% endif %}><label for="loc-site">On-site</label></div>
                    <div class="choice-item"><input type="radio" id="loc-wfh" name="work_location" value="WorkFromHome" {% if form_data.get('work_location') == 'WorkFromHome' %}checked{% endif %}><label for="loc-wfh">Work from Home</label></div>
                </div>
            </div>
            <div class="form-group">
                <label class="group-label">Work Schedule</label>
                <div class="choice-group">
                    <div class="choice-item"><input type="radio" id="time-full" name="work_time" value="Full-time" {% if form_data.get('work_time') == 'Full-time' %}checked{% endif %}><label for="time-full">Full-time</label></div>
                    <div class="choice-item"><input type="radio" id="time-part" name="work_time" value="Part-time" {% if form_data.get('work_time') == 'Part-time' %}checked{% endif %}><label for="time-part">Part-time</label></div>
                </div>
            </div>
            <div class="form-group">
                <label class="group-label">Shifts</label>
                <div class="choice-group">
                    <div class="choice-item"><input type="radio" id="shift-fixed" name="shifts" value="Fixed" {% if form_data.get('shifts') == 'Fixed' %}checked{% endif %}><label for="shift-fixed">Fixed</label></div>
                    <div class="choice-item"><input type="radio" id="shift-rotational" name="shifts" value="Rotational" {% if form_data.get('shifts') == 'Rotational' %}checked{% endif %}><label for="shift-rotational">Rotational</label></div>
                </div>
            </div>

            <!-- Benefits (Checkboxes) -->
            <div class="form-group full-width">
                <label class="group-label">Benefits Included</label>
                <div class="choice-group">
                    {% set benefits = form_data.get('benefits', []) %}
                    <div class="choice-item"><input type="checkbox" id="benefit-training" name="benefits" value="PaidTraining" {% if 'PaidTraining' in benefits %}checked{% endif %}><label for="benefit-training">Paid Training</label></div>
                    <div class="choice-item"><input type="checkbox" id="benefit-social" name="benefits" value="SocialInsurance" {% if 'SocialInsurance' in benefits %}checked{% endif %}><label for="benefit-social">Social Insurance</label></div>
                    <div class="choice-item"><input type="checkbox" id="benefit-medical" name="benefits" value="MedicalInsurance" {% if 'MedicalInsurance' in benefits %}checked{% endif %}><label for="benefit-medical">Medical Insurance</label></div>
                </div>
            </div>

            <!-- Transportation -->
            <div class="form-group full-width">
                <label class="group-label">Transportation Provided?</label>
                <div class="choice-group">
                    <div class="choice-item"><input type="radio" id="transport-no" name="transportation" value="no" {% if form_data.get('transportation', 'no') == 'no' %}checked{% endif %}><label for="transport-no">No</label></div>
                    <div class="choice-item"><input type="radio" id="transport-yes" name="transportation" value="yes" {% if form_data.get('transportation') == 'yes' %}checked{% endif %}><label for="transport-yes">Yes</label></div>
                </div>
            </div>

            <!-- Conditional Transportation Type -->
            <div id="transportation-type-group" class="form-group full-width conditional-field" style="display: {% if form_data.get('transportation') == 'yes' %}grid{% else %}none{% endif %};">
                <label class="group-label">If yes, what type?</label>
                <div class="choice-group">
                    <div class="choice-item"><input type="radio" id="transport-d2d" name="transport_type" value="DoorToDoor" {% if form_data.get('transport_type') == 'DoorToDoor' %}checked{% endif %}><label for="transport-d2d">Door to Door</label></div>
                    <div class="choice-item"><input type="radio" id="transport-pickup" name="transport_type" value="PickupPoint" {% if form_data.get('transport_type') == 'PickupPoint' %}checked{% endif %}><label for="transport-pickup">To Nearest Pickup Point</label></div>
                </div>
            </div>

            <!-- Other Fields (Status, Closing Date, Featured) -->
            {% if is_editing_live %}
            <div class="form-group">
                <label for="status">Status <span class="required">*</span></label>
                <select id="status" name="status" required>
                    {% set current_status = form_data.get('status', form_data.get('Status', 'Open')) %}
                    <option value="Open" {% if current_status == 'Open' %}selected{% endif %}>Open</option>
                    <option value="Filled" {% if current_status == 'Filled' %}selected{% endif %}>Filled</option>
                    <option value="Closed" {% if current_status == 'Closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>
            {% endif %}
            <div class="form-group">
                <label for="closing_date">Closing Date (Optional)</label>
                <input type="date" id="closing_date" name="closing_date" value="{{ form_data.get('closing_date', '') }}">
            </div>
            <div class="form-group" style="align-self: end;">
                <input type="checkbox" id="is_featured" name="is_featured" value="on" {% if form_data.get('is_featured') or form_data.get('IsFeatured') %}checked{% endif %}>
                <label for="is_featured" style="display: inline; font-weight: normal; margin-left: 0.25rem;">Is Featured Offer?</label>
            </div>
        </div>

        <div class="form-actions full-width" style="margin-top: 1.5rem; text-align: right;">
            <a href="{{ url_for('job_offer_mgmt_bp.list_all_job_offers') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">{{ action_verb }} Offer</button>
        </div>
         {% if errors.get('form') %}
            <div class="alert alert-danger" style="margin-top: 1rem;">{{ errors.get('form') }}</div>
        {% endif %}
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const transportRadios = document.querySelectorAll('input[name="transportation"]');
    const transportTypeGroup = document.getElementById('transportation-type-group');

    const toggleTransportType = () => {
        const selected = document.querySelector('input[name="transportation"]:checked');
        if (selected && selected.value === 'yes') {
            transportTypeGroup.style.display = 'grid'; // Use grid to match form layout
        } else {
            transportTypeGroup.style.display = 'none';
        }
    };

    transportRadios.forEach(radio => radio.addEventListener('change', toggleTransportType));

    // Initial check on page load
    toggleTransportType();
});
</script>

<style>
    .required { color: red; }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem 1.5rem;
    }
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    .form-actions.full-width {
        grid-column: 1 / -1;
    }
    .choice-group { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .choice-item { display: flex; align-items: center; gap: 0.4rem; }
    .choice-item input[type="radio"], .choice-item input[type="checkbox"] { margin: 0; }
    .choice-item label { margin: 0; font-weight: normal; cursor: pointer; }
    .conditional-field {
        padding-left: 1rem;
        border-left: 3px solid #007bff;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}