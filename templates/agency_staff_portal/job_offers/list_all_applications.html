{# templates/agency_staff_portal/job_offers/list_all_applications.html #}
{% extends "agency_staff_portal/staff_base.html" %}

{% block staff_title %}{{ title }}{% endblock %}

{% block staff_page_title %}
    <i class="bi bi-journal-text text-text-muted"></i>
    <span class="fluid-text-lg">{{ title }}</span>
{% endblock %}

{% block staff_content %}
<div>
    <!-- [UPDATED] Tab Navigation: now horizontally scrollable on small screens -->
    <div class="mb-6">
        <div class="border-b border-border">
            <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                <a href="{{ url_for('.list_all_applications', company_id=selected_company_id, offer_id=selected_offer_id) }}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {% if not selected_filter_status %}border-primary text-primary{% else %}border-transparent text-text-muted hover:text-text hover:border-border{% endif %}">All Applications</a>
                <a href="{{ url_for('.list_all_applications', filter_status='Applied', company_id=selected_company_id, offer_id=selected_offer_id) }}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {% if selected_filter_status == 'Applied' %}border-primary text-primary{% else %}border-transparent text-text-muted hover:text-text hover:border-border{% endif %}">New for Review</a>
                <a href="{{ url_for('.list_all_applications', filter_status='Shortlisted', company_id=selected_company_id, offer_id=selected_offer_id) }}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {% if selected_filter_status == 'Shortlisted' %}border-primary text-primary{% else %}border-transparent text-text-muted hover:text-text hover:border-border{% endif %}">Shortlisted</a>
                <a href="{{ url_for('.list_all_applications', filter_status='Interview Scheduled', company_id=selected_company_id, offer_id=selected_offer_id) }}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {% if selected_filter_status == 'Interview Scheduled' %}border-primary text-primary{% else %}border-transparent text-text-muted hover:text-text hover:border-border{% endif %}">Interview Scheduled</a>
            </nav>
        </div>
    </div>

    <!-- Filter Section (already responsive) -->
    <div class="bg-card p-4 sm:p-6 rounded-lg shadow border border-border mb-6">
        <form method="GET" action="{{ url_for('job_offer_mgmt_bp.list_all_applications') }}" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <input type="hidden" name="filter_status" value="{{ selected_filter_status or '' }}">
            <div class="md:col-span-2"><label for="company_id" class="form-label">Company</label><select name="company_id" id="company_id" class="form-select"><option value="">All Companies</option>{% for company in companies %}<option value="{{ company.CompanyID }}" {% if company.CompanyID == selected_company_id %}selected{% endif %}>{{ company.CompanyName }}</option>{% endfor %}</select></div>
            <div class="md:col-span-2"><label for="offer_id" class="form-label">Job Offer</label><select name="offer_id" id="offer_id" class="form-select"><option value="">All Job Offers</option></select></div>
            <div class="flex space-x-2 pt-5"><button type="submit" class="btn-primary w-full"><i class="bi bi-funnel-fill mr-2"></i>Filter</button><a href="{{ url_for('job_offer_mgmt_bp.list_all_applications') }}" class="btn-secondary w-full text-center">Clear</a></div>
        </form>
    </div>

    <!-- Actions and Summary -->
    <div class="flex flex-col sm:flex-row gap-4 justify-between sm:items-center mb-4 px-1">
        <p class="text-sm text-text-muted">Displaying <span class="font-bold text-heading">{{ applications|length }}</span> applications.</p>
        <div class="relative inline-block text-left" x-data="{ open: false }">
            <button @click="open = !open" type="button" class="btn-secondary w-full sm:w-auto"><i class="bi bi-download mr-2"></i>Download Report<i class="bi bi-chevron-down ml-2"></i></button>
            <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-card shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" style="display: none;">
                <div class="py-1"><a href="{{ url_for('.list_all_applications', company_id=selected_company_id, offer_id=selected_offer_id, filter_status=selected_filter_status, format='xlsx') }}" class="text-text block px-4 py-2 text-sm hover:bg-background"><i class="bi bi-file-earmark-spreadsheet-fill text-green-600 mr-3"></i>Styled Report (.xlsx)</a><a href="{{ url_for('.list_all_applications', company_id=selected_company_id, offer_id=selected_offer_id, filter_status=selected_filter_status, format='csv') }}" class="text-text block px-4 py-2 text-sm hover:bg-background"><i class="bi bi-filetype-csv text-gray-500 mr-3"></i>Plain Data (.csv)</a></div>
            </div>
        </div>
    </div>

    <!-- [UPDATED] Desktop Table View -->
    <div class="hidden md:block bg-card rounded-lg shadow border border-border overflow-hidden">
        <table class="min-w-full divide-y divide-border text-sm">
            <thead class="bg-background"><tr class="text-left text-xs font-medium text-text-muted uppercase tracking-wider"><th class="px-6 py-3">Candidate</th><th class="px-6 py-3">Job / Company</th><th class="px-6 py-3">Applied On</th><th class="px-6 py-3 text-center">Status</th><th class="px-6 py-3 text-center">Actions</th></tr></thead>
            <tbody class="divide-y divide-border">
                {% for app in applications %}
                <tr class="hover:bg-background/50"><td class="px-6 py-4 font-medium text-heading">{{ app.FirstName }} {{ app.LastName }}</td><td class="px-6 py-4 text-text-muted"><div class="font-medium text-text">{{app.JobTitle}}</div><div>{{app.CompanyName}}</div></td><td class="px-6 py-4 text-text-muted">{{ app.ApplicationDate.strftime('%Y-%m-%d') if app.ApplicationDate }}</td>
                    <td class="px-6 py-4 text-center">
                        {% set status_classes = {'Hired': 'bg-success/10 text-success-700','Rejected': 'bg-danger/10 text-danger-700'} %}
                        <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full {{ status_classes.get(app.Status, 'bg-primary/10 text-primary-800') }}">{{ app.Status }}</span>
                    </td>
                    <td class="px-6 py-4 text-center"><a href="{{ url_for('job_offer_mgmt_bp.view_application_details', application_id=app.ApplicationID) }}" class="font-medium text-primary hover:underline">View Details</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- [NEW] Mobile Card View -->
    <div class="md:hidden space-y-4">
        {% for app in applications %}
        <div class="bg-card p-4 rounded-lg shadow border border-border">
            <div class="flex justify-between items-start">
                <div>
                    <div class="font-semibold text-heading">{{ app.FirstName }} {{ app.LastName }}</div>
                    <div class="text-sm text-text-muted">{{ app.JobTitle }} at {{ app.CompanyName }}</div>
                </div>
                {% set status_classes = {'Hired': 'bg-success/10 text-success-700','Rejected': 'bg-danger/10 text-danger-700'} %}
                <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full {{ status_classes.get(app.Status, 'bg-primary/10 text-primary-800') }}">{{ app.Status }}</span>
            </div>
            <div class="mt-4 pt-4 border-t border-border flex justify-between items-center">
                <span class="text-xs text-text-muted">Applied: {{ app.ApplicationDate.strftime('%d %b, %Y') if app.ApplicationDate }}</span>
                <a href="{{ url_for('job_offer_mgmt_bp.view_application_details', application_id=app.ApplicationID) }}" class="btn-secondary text-xs">View Details</a>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not applications %}
    <div class="bg-card rounded-lg shadow border border-border text-center py-16 text-text-muted">
        <i class="bi bi-search text-5xl text-border"></i><p class="mt-2">No applications found for the selected criteria.</p>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block staff_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companySelect = document.getElementById('company_id');
    const offerSelect = document.getElementById('offer_id');
    const initiallySelectedOfferId = "{{ selected_offer_id or '' }}";

    function fetchAndPopulateOffers(companyId) {
        const url = companyId 
            ? `{{ url_for('job_offer_mgmt_bp.api_get_offers_for_company', company_id=0) }}`.replace('0', companyId)
            : `{{ url_for('job_offer_mgmt_bp.api_get_all_offers') }}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                offerSelect.innerHTML = '<option value="">All Job Offers</option>';
                data.offers.forEach(offer => {
                    const option = document.createElement('option');
                    option.value = offer.OfferID;
                    option.textContent = offer.Title;
                    if (offer.OfferID == initiallySelectedOfferId) {
                        option.selected = true;
                    }
                    offerSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching job offers:', error);
                offerSelect.innerHTML = '<option value="">Could not load offers</option>';
            });
    }

    companySelect.addEventListener('change', function() {
        fetchAndPopulateOffers(this.value);
    });

    fetchAndPopulateOffers(companySelect.value);
});
</script>
{% endblock %}