<!-- templates/agency_staff_portal/staff/view_staff_profile.html -->
{% extends "agency_staff_portal/staff_base.html" %}

{% block staff_title %}{{ title }}{% endblock %}
{% block staff_page_title %}{{ title }}{% endblock %}

{% block staff_content %}
{% set is_executive_viewer = current_user.role_type in ['CEO', 'Admin', 'Founder'] %}
{% set is_direct_manager = current_user.specific_role_id == user_profile.ReportsToStaffID %}
{% set can_manage_this_user_fully = is_executive_viewer %}
{% set can_manage_points_for_this_user = (is_executive_viewer or is_direct_manager) and user_profile.StaffID %}

<div class="mb-6">
    <a href="{{ url_for('staff_perf_bp.list_all_staff') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
        <i class="bi bi-arrow-left -ml-1 mr-2"></i> Back to All Staff
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column: Main Profile & Management -->
    <div class="lg:col-span-1 space-y-8">
        <!-- Profile Card -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
            <img src="{{ user_profile.ProfilePictureURL or url_for('static', filename='images/default-profile.png') }}" alt="{{ user_profile.FirstName }}" class="w-28 h-28 rounded-full object-cover border-4 border-gray-100 shadow-md mx-auto">
            <h3 class="text-2xl font-bold text-gray-800 mt-4">{{ user_profile.FirstName }} {{ user_profile.LastName }}</h3>
            <p class="text-gray-500">{{ user_profile.Role or 'No role assigned' }}</p>
            {% if user_profile.AccountStatus == 'Active' %}
                <span class="mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
            {% else %}
                <span class="mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Inactive</span>
            {% endif %}
        </div>

        <!-- Contact & Team Info -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-3 mb-4">Details</h4>
            <dl class="space-y-3 text-sm">
                <div class="flex justify-between"><dt class="font-medium text-gray-500">Email</dt><dd class="text-gray-900 text-right">{{ user_profile.Email }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-500">Phone</dt><dd class="text-gray-900 text-right">{{ user_profile.PhoneNumber or 'N/A' }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-500">Member Since</dt><dd class="text-gray-900 text-right">{{ user_profile.RegistrationDate.strftime('%b %d, %Y') if user_profile.RegistrationDate else 'N/A' }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-500">Reports To</dt><dd class="text-gray-900 text-right">{{ user_profile.LeaderFirstName + ' ' + user_profile.LeaderLastName if user_profile.LeaderFirstName else 'N/A' }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-500">Sourcing Team</dt><dd class="text-gray-900 text-right">{{ user_profile.SourcingTeamName or 'N/A' }}</dd></div>
                <div class="flex justify-between"><dt class="font-medium text-gray-500">AM Team</dt><dd class="text-gray-900 text-right">{{ user_profile.AMTeamName or 'N/A' }}</dd></div>
            </dl>
        </div>

        <!-- Management Tools -->
        {% if can_manage_this_user_fully %}
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
            <h4 class="text-lg font-semibold text-gray-900">Management Tools</h4>
            <!-- Update Role Form -->
            <form action="{{ url_for('staff_perf_bp.update_role', staff_id_to_edit=user_profile.StaffID) }}" method="POST">
                <input type="hidden" name="user_id" value="{{ user_profile.UserID }}">
                <label for="role" class="block text-sm font-medium text-gray-700">Assign Role</label>
                <div class="mt-1 flex gap-2">
                    <select name="role" id="role" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        {% for role_option in possible_roles %}<option value="{{ role_option }}" {% if role_option == user_profile.Role %}selected{% endif %}>{{ role_option }}</option>{% endfor %}
                    </select>
                    <button type="submit" class="btn-primary-sm">Save</button>
                </div>
            </form>
            <!-- Update Leader Form -->
            <form action="{{ url_for('staff_perf_bp.update_leader', staff_id_to_edit=user_profile.StaffID) }}" method="POST">
                 <input type="hidden" name="user_id" value="{{ user_profile.UserID }}">
                 <label for="leader_id" class="block text-sm font-medium text-gray-700">Assign Manager</label>
                 <div class="mt-1 flex gap-2">
                    <select name="leader_id" id="leader_id" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        <option value="">-- No Manager --</option>
                        {% for leader in team_leaders %}{% if leader.StaffID != user_profile.StaffID %}<option value="{{ leader.StaffID }}" {% if leader.StaffID == user_profile.ReportsToStaffID %}selected{% endif %}>{{ leader.FullName }}</option>{% endif %}{% endfor %}
                    </select>
                    <button type="submit" class="btn-primary-sm">Save</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Performance & Activity -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Performance Snapshot -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-3 mb-4">Performance Snapshot</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-center">
                <div><div class="text-3xl font-bold text-primary-600">{{ user_profile.TotalPoints or 0 }}</div><div class="text-sm text-gray-500">All-Time Points</div></div>
                <div><div class="text-3xl font-bold text-gray-800">{{ user_profile.PointsThisMonth or 0 }}</div><div class="text-sm text-gray-500">Points This Month</div></div>
                <div><div class="text-3xl font-bold text-gray-800">{{ user_profile.AppsReferredThisMonth or 0 }}</div><div class="text-sm text-gray-500">Apps Referred (Month)</div></div>
                <div><div class="text-3xl font-bold text-green-600">{{ user_profile.HiresThisMonth or 0 }}</div><div class="text-sm text-gray-500">Hires This Month</div></div>
            </div>
        </div>

        <!-- Direct Reports -->
        {% if direct_reports %}
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-3 mb-4">Direct Reports ({{ direct_reports|length }})</h4>
            <ul class="space-y-3">
                {% for report in direct_reports %}
                <li class="flex items-center justify-between">
                    <div>
                        <a href="{{ url_for('staff_perf_bp.view_staff_profile', user_id_viewing=report.UserID) }}" class="font-medium text-primary-600 hover:underline">{{ report.FirstName }} {{ report.LastName }}</a>
                        <p class="text-sm text-gray-500">{{ report.Role }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Recent Point Transactions -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-3 mb-4">Recent Point Transactions</h4>
            {% if point_transactions %}
                <ul class="space-y-4">
                {% for tx in point_transactions %}
                    <li class="flex items-start justify-between">
                        <div>
                            <p class="font-medium text-gray-800">{{ tx.Reason }}</p>
                            <p class="text-xs text-gray-500">By {{ tx.AssignerFirstName }} on {{ tx.TransactionDate.strftime('%d %b %Y') }}</p>
                        </div>
                        {% if tx.Points > 0 %}
                            <span class="text-green-600 font-bold text-lg">+{{ tx.Points }}</span>
                        {% else %}
                             <span class="text-red-600 font-bold text-lg">{{ tx.Points }}</span>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-sm text-gray-500 text-center py-4">No point transactions recorded yet.</p>
            {% endif %}
        </div>

        {% if is_profile_eligible_for_points %}
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900">Adjust Points</h4>
            <form action="{{ url_for('staff_perf_bp.add_points', staff_id_award_points=user_profile.StaffID) }}" method="POST" class="mt-4 space-y-4">
                <input type="hidden" name="user_id" value="{{ user_profile.UserID }}">
                <div>
                    <label for="points" class="block text-sm font-medium text-gray-700">Points</label>
                    <input type="number" name="points" id="points" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                </div>
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700">Reason</label>
                    <input type="text" name="reason" id="reason" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="submit" name="action_type" value="deduct" class="btn-danger">Deduct Points</button>
                    <button type="submit" name="action_type" value="add" class="btn-success">Award Points</button>
                </div>
            </form>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}