{# templates/agency_staff_portal/staff/staff_dashboard.html #}
{% extends "agency_staff_portal/staff_base.html" %}

{% block staff_title %}Staff Dashboard{% endblock %}

{% block staff_page_title %}
<i class="bi bi-speedometer2 text-primary-600"></i>
<span>Staff Dashboard</span>
{% endblock %}

{% block staff_content %}
<div class="space-y-8">
    
    <!-- Stat Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Total Active Staff -->
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-100 rounded-lg p-3">
                        <i class="bi bi-person-workspace text-3xl text-green-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Active Staff</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.total_active_staff }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pending Applications -->
        <a href="{{ url_for('staff_perf_bp.review_staff_applications') }}" class="relative bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1 block">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-yellow-100 rounded-lg p-3">
                        <i class="bi bi-person-vcard text-3xl text-yellow-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending Applications</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.pending_applications }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
            {% if stats.pending_applications > 0 %}
            <span class="absolute top-3 right-3 flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
            </span>
            {% endif %}
        </a>
        <!-- Sourcing Teams -->
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-blue-100 rounded-lg p-3">
                        <i class="bi bi-diagram-3-fill text-3xl text-blue-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Sourcing Teams</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.sourcing_teams }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        <!-- Account Manager Teams -->
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-indigo-100 rounded-lg p-3">
                        <i class="bi bi-person-rolodex text-3xl text-indigo-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">AM Teams</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.am_teams }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <!-- Left Column (Span 3) - Chart -->
        <div class="lg:col-span-3 bg-white shadow-sm rounded-xl border border-gray-200 p-6">
            <h3 class="text-lg leading-6 font-semibold text-gray-900 mb-4">Active Staff by Role</h3>
            <div class="relative h-96">
                <canvas id="staffByRoleChart"></canvas>
                <div id="noChartData" class="absolute inset-0 items-center justify-center hidden">
                    <div class="text-center text-gray-500">
                        <i class="bi bi-bar-chart-line text-4xl"></i>
                        <p class="mt-2 font-medium">No Staff Data to Display</p>
                        <p class="text-sm">The chart will appear here once there is active staff.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column (Span 2) - Lists -->
        <div class="lg:col-span-2 space-y-8">

            <!-- ##### QUICK ACTIONS & LINKS CARD (RESTORED) ##### -->
            <div class="bg-white shadow-sm rounded-xl border border-gray-200">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-base font-semibold text-gray-900">Quick Actions & Links</h3>
                </div>
                <div class="p-4 space-y-3">
                    <a href="{{ url_for('staff_perf_bp.add_staff') }}" class="w-full flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="bi bi-person-plus-fill -ml-1 mr-2"></i> Add New Staff
                    </a>
                    <a href="{{ url_for('staff_perf_bp.list_all_staff') }}" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="bi bi-person-lines-fill -ml-1 mr-2"></i> Manage All Staff
                    </a>
                    <a href="{{ url_for('staff_perf_bp.global_team_overview') }}" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="bi bi-diagram-3 -ml-1 mr-2"></i> View Team Structure
                    </a>
                </div>
            </div>

            <!-- Top Monthly Performers -->
            <div class="bg-white shadow-sm rounded-xl border border-gray-200">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-base font-semibold text-gray-900">Top Performers (This Month)</h3>
                    <a href="{{ url_for('staff_perf_bp.performance_leaderboard', period='monthly') }}" class="text-sm text-primary-600 hover:text-primary-800 font-medium">View All <i class="bi bi-arrow-right-short"></i></a>
                </div>
                <ul role="list" class="divide-y divide-gray-200">
                    {% for performer in top_performers %}
                    <li class="p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="h-10 w-10 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center font-bold text-lg">
                                {{ loop.index }}
                            </span>
                            <div>
                                <p class="font-medium text-gray-800">{{ performer.FirstName }} {{ performer.LastName }}</p>
                                <p class="text-sm text-gray-500">{{ performer.Role }}</p>
                            </div>
                        </div>
                        <span class="font-bold text-green-600 text-lg">{{ performer.Points|int }} Pts</span>
                    </li>
                    {% else %}
                    <li class="p-4 text-center text-gray-500">No performance data for this month yet.</li>
                    {% endfor %}
                </ul>
            </div>
            
            <!-- Recently Joined Staff -->
            <div class="bg-white shadow-sm rounded-xl border border-gray-200">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-base font-semibold text-gray-900">Recently Joined Staff</h3>
                    <a href="{{ url_for('staff_perf_bp.list_all_staff') }}" class="text-sm text-primary-600 hover:text-primary-800 font-medium">Manage Staff <i class="bi bi-arrow-right-short"></i></a>
                </div>
                <ul role="list" class="divide-y divide-gray-200">
                    {% for staff in recent_hires %}
                    <li class="p-4 flex items-center justify-between">
                         <div class="flex items-center space-x-3">
                            <span class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="bi bi-person-fill text-xl text-gray-500"></i>
                            </span>
                            <div>
                                <p class="font-medium text-gray-800">{{ staff.FirstName }} {{ staff.LastName }}</p>
                                <p class="text-sm text-gray-500">{{ staff.Role }}</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-500">{{ staff.ReviewedAt.strftime('%b %d, %Y') }}</span>
                    </li>
                    {% else %}
                    <li class="p-4 text-center text-gray-500">No recent hires found.</li>
                    {% endfor %}
                </ul>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block staff_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Safely parse data from Jinja. It will become a valid JavaScript array.
    const roleData = {{ staff_by_role|tojson|safe }};

    const chartCanvas = document.getElementById('staffByRoleChart');
    const noDataMessage = document.getElementById('noChartData');
    
    if (roleData && roleData.length > 0) {
        // We have data, so show the canvas and hide the message
        chartCanvas.style.display = 'block';
        noDataMessage.style.display = 'none';

        const roleLabels = roleData.map(item => item.Role);
        const roleCounts = roleData.map(item => item.count);

        try {
            const ctx = chartCanvas.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: roleLabels,
                    datasets: [{
                        label: 'Number of Staff',
                        data: roleCounts,
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.7)',  // Indigo
                            'rgba(59, 130, 246, 0.7)',  // Blue
                            'rgba(16, 185, 129, 0.7)',  // Green
                            'rgba(245, 158, 11, 0.7)', // Amber
                            'rgba(239, 68, 68, 0.7)',   // Red
                            'rgba(139, 92, 246, 0.7)',  // Violet
                            'rgba(236, 72, 153, 0.7)'  // Pink
                        ],
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y', // Makes it a horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                drawBorder: false,
                            },
                            ticks: {
                                precision: 0 // Ensure axis has whole numbers
                            }
                        },
                        y: {
                           grid: {
                                display: false,
                           } 
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // The chart is self-explanatory
                        },
                        tooltip: {
                            backgroundColor: '#111827',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 6,
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        } catch (error) {
            // If chart creation fails, log the error and show the no-data message.
            console.error('Error creating chart:', error);
            chartCanvas.style.display = 'none';
            noDataMessage.style.display = 'flex'; // Use flex to center the content
        }
    } else {
        // No data, so hide the canvas and show the message
        chartCanvas.style.display = 'none';
        noDataMessage.style.display = 'flex'; // Use flex to center the content
    }
});
</script>
{% endblock %}