{# templates/agency_staff_portal/staff/staff_dashboard.html #}
{% extends "agency_staff_portal/staff_base.html" %}

{% block staff_title %}Staff Dashboard{% endblock %}

{% block staff_page_title %}
<i class="bi bi-speedometer2 text-primary-600"></i>
<span>Staff Dashboard</span>
{% endblock %}

{% block staff_content %}
<div class="space-y-8">
    
    <!-- Stat Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Total Active Staff -->
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-100 rounded-lg p-3">
                        <i class="bi bi-person-workspace text-3xl text-green-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Active Staff</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.total_active_staff }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pending Applications -->
        <a href="{{ url_for('staff_perf_bp.review_staff_applications') }}" class="relative bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1 block">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-yellow-100 rounded-lg p-3">
                        <i class="bi bi-person-vcard text-3xl text-yellow-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending Applications</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.pending_applications }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
            {% if stats.pending_applications > 0 %}
            <span class="absolute top-3 right-3 flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
            </span>
            {% endif %}
        </a>
        <!-- Sourcing Teams -->
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-blue-100 rounded-lg p-3">
                        <i class="bi bi-diagram-3-fill text-3xl text-blue-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Sourcing Teams</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.sourcing_teams }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        <!-- Account Manager Teams -->
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 transition-all hover:shadow-lg hover:-translate-y-1">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-indigo-100 rounded-lg p-3">
                        <i class="bi bi-person-rolodex text-3xl text-indigo-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">AM Teams</dt>
                            <dd class="text-3xl font-bold text-gray-900">{{ stats.am_teams }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <!-- Left Column (Span 3) - Chart -->
        <div class="lg:col-span-3 bg-white shadow-sm rounded-xl border border-gray-200 p-6">
            <h3 class="text-lg leading-6 font-semibold text-gray-900 mb-4">Active Staff by Role</h3>
            <div class="h-96">
                {% if staff_by_role %}
                <canvas id="staffByRoleChart"></canvas>
                {% else %}
                <div class="flex items-center justify-center h-full text-gray-500">
                    <p>No staff data to display.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column (Span 2) - Lists -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Top Monthly Performers -->
            <div class="bg-white shadow-sm rounded-xl border border-gray-200">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-base font-semibold text-gray-900">Top Performers (This Month)</h3>
                    <a href="{{ url_for('staff_perf_bp.performance_leaderboard', period='monthly') }}" class="text-sm text-primary-600 hover:text-primary-800 font-medium">View All <i class="bi bi-arrow-right-short"></i></a>
                </div>
                <ul role="list" class="divide-y divide-gray-200">
                    {% for performer in top_performers %}
                    <li class="p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="h-10 w-10 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center font-bold text-lg">
                                {{ loop.index }}
                            </span>
                            <div>
                                <p class="font-medium text-gray-800">{{ performer.FirstName }} {{ performer.LastName }}</p>
                                <p class="text-sm text-gray-500">{{ performer.Role }}</p>
                            </div>
                        </div>
                        <span class="font-bold text-green-600 text-lg">{{ performer.Points|int }} Pts</span>
                    </li>
                    {% else %}
                    <li class="p-4 text-center text-gray-500">No performance data for this month yet.</li>
                    {% endfor %}
                </ul>
            </div>
            
            <!-- Recently Joined Staff -->
            <div class="bg-white shadow-sm rounded-xl border border-gray-200">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-base font-semibold text-gray-900">Recently Joined Staff</h3>
                    <a href="{{ url_for('staff_perf_bp.list_all_staff') }}" class="text-sm text-primary-600 hover:text-primary-800 font-medium">Manage Staff <i class="bi bi-arrow-right-short"></i></a>
                </div>
                <ul role="list" class="divide-y divide-gray-200">
                    {% for staff in recent_hires %}
                    <li class="p-4 flex items-center justify-between">
                         <div class="flex items-center space-x-3">
                            <span class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="bi bi-person-fill text-xl text-gray-500"></i>
                            </span>
                            <div>
                                <p class="font-medium text-gray-800">{{ staff.FirstName }} {{ staff.LastName }}</p>
                                <p class="text-sm text-gray-500">{{ staff.Role }}</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-500">{{ staff.ReviewedAt.strftime('%b %d, %Y') }}</span>
                    </li>
                    {% else %}
                    <li class="p-4 text-center text-gray-500">No recent hires found.</li>
                    {% endfor %}
                </ul>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block staff_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleData = {{ staff_by_role|tojson|safe }};
    
    if (roleData && roleData.length > 0) {
        const roleLabels = roleData.map(item => item.Role);
        const roleCounts = roleData.map(item => item.count);

        const ctx = document.getElementById('staffByRoleChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: roleLabels,
                datasets: [{
                    label: 'Number of Staff',
                    data: roleCounts,
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.7)',  // Indigo
                        'rgba(59, 130, 246, 0.7)',  // Blue
                        'rgba(16, 185, 129, 0.7)',  // Green
                        'rgba(245, 158, 11, 0.7)', // Amber
                        'rgba(239, 68, 68, 0.7)',   // Red
                        'rgba(139, 92, 246, 0.7)',  // Violet
                        'rgba(236, 72, 153, 0.7)'  // Pink
                    ],
                    borderColor: [
                        'rgb(79, 70, 229)',
                        'rgb(59, 130, 246)',
                        'rgb(16, 185, 129)',
                        'rgb(245, 158, 11)',
                        'rgb(239, 68, 68)',
                        'rgb(139, 92, 246)',
                        'rgb(236, 72, 153)'
                    ],
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y', // Makes it a horizontal bar chart
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            drawBorder: false,
                        },
                        ticks: {
                            precision: 0 // Ensure axis has whole numbers
                        }
                    },
                    y: {
                       grid: {
                            display: false,
                       } 
                    }
                },
                plugins: {
                    legend: {
                        display: false // The chart is self-explanatory
                    },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 12,
                        cornerRadius: 6,
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
});
</script>
{% endblock %}