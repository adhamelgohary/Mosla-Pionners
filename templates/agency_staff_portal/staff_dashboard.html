{# templates/agency_staff_portal/staff_dashboard.html #}
{% extends "agency_staff_portal/staff_base.html" %}

{% block staff_title %}{{ title }}{% endblock %}

{% block staff_page_title %}
    Dashboard
{% endblock %}

{% block staff_content %}
<div>
    <!-- Welcome Header -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800">Welcome back, {{ current_user.first_name }}!</h2>
        <p class="text-gray-500">Here's a snapshot of your performance and agency activity.</p>
    </div>

    <!-- KPI Cards Grid -->
    <div>
        <h3 class="text-base font-semibold leading-6 text-gray-900">Key Performance Indicators</h3>
        <dl class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            
            {# --- Personal Performance KPIs --- #}
            {% if 'my_referred_applications_month' in dashboard_stats %}
            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-indigo-500 p-3">
                        <i class="bi bi-send-check-fill text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">My Referrals (30d)</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.my_referred_applications_month }}</p>
                    <p class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                        <span class="sr-only">Applications</span>
                        applications
                    </p>
                </dd>
            </div>
            {% endif %}

            {% if 'my_managed_clients' in dashboard_stats %}
            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-indigo-500 p-3">
                        <i class="bi bi-person-workspace text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">My Managed Clients</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.my_managed_clients }}</p>
                </dd>
            </div>
            {% endif %}
            
            {% if 'team_managed_clients' in dashboard_stats %}
            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-indigo-500 p-3">
                        <i class="bi bi-diagram-3-fill text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">Team's Managed Clients</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.team_managed_clients }}</p>
                </dd>
            </div>
            {% endif %}

            {# --- Agency-Wide KPIs (For Executives) --- #}
            {% if is_executive %}
            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-blue-500 p-3">
                        <i class="bi bi-people-fill text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">Total Candidates</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.total_candidates_system }}</p>
                </dd>
            </div>
            
            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-blue-500 p-3">
                        <i class="bi bi-building-fill text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">Total Companies</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.total_companies }}</p>
                </dd>
            </div>
            
            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-blue-500 p-3">
                        <i class="bi bi-briefcase-fill text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">Open Job Offers</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.open_job_offers }}</p>
                </dd>
            </div>

            <div class="relative overflow-hidden rounded-lg bg-white px-4 pb-12 pt-5 shadow sm:px-6 sm:pt-6">
                <dt>
                    <div class="absolute rounded-md bg-blue-500 p-3">
                        <i class="bi bi-person-badge-fill text-white h-6 w-6"></i>
                    </div>
                    <p class="ml-16 truncate text-sm font-medium text-gray-500">Active Staff</p>
                </dt>
                <dd class="ml-16 flex items-baseline pb-6 sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboard_stats.active_staff_count }}</p>
                </dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Announcements and Activity Feed -->
    <div class="mt-12 grid grid-cols-1 gap-8 lg:grid-cols-2">
        <!-- Manual Announcements -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-4 mb-4">Announcements</h3>
            {% if manual_announcements %}
                <ul class="space-y-4">
                    {% for item in manual_announcements %}
                    <li>
                        <div class="font-semibold text-gray-800">{{ item.Title }}</div>
                        <p class="text-sm text-gray-600">{{ item.Content }}</p>
                        <p class="text-xs text-gray-400 mt-1">Posted by {{ item.PosterFirstName }} on {{ item.CreatedAt.strftime('%b %d') }}</p>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-center text-gray-500 py-6">No new announcements.</p>
            {% endif %}
        </div>

        <!-- Automated Activity Feed -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-4 mb-4">Recent Activity</h3>
            {% if activity_feed_items %}
                <ul class="space-y-4">
                    {% for item in activity_feed_items %}
                    <li class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100">
                                <i class="bi {{ 'bi-megaphone-fill' if item.Source == 'Automated_Offer' else 'bi-mortarboard-fill' }} text-blue-600"></i>
                            </span>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800">{{ item.Title }}</div>
                            <p class="text-sm text-gray-500">{{ item.CreatedAt.strftime('%d %b, %Y at %I:%M %p') }}</p>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                 <p class="text-center text-gray-500 py-6">No recent automated activity.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}